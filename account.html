<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - Crypto Trading Market</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }
    
    body, html {
      height: 100%;
      color: #0c0b0b;
      overflow-x: hidden;
      position: relative;
    }
    
    .background-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }
    
    .background-container video {
      min-width: 100%;
      min-height: 100%;
      width: auto;
      height: auto;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      object-fit: cover;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(12, 12, 12, 0.85);
      padding: 8px 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
      z-index: 1;
    }
    
    .logo-title {
      display: flex;
      align-items: center;
    }
    
    .logo-title video {
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }
    
    .logo-title h1 {
      font-size: 20px;
      font-weight: bold;
      color: #2e7d32;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .nav {
      display: flex;
      gap: 8px;
    }
    
    .nav a {
      color: #2e7d32;
      text-decoration: none;
      font-weight: bold;
      padding: 5px 8px;
      border-radius: 4px;
      transition: background 0.3s;
      font-size: 14px;
      white-space: nowrap;
    }
    
    .nav a:hover {
      background: rgba(232, 245, 233, 0.7);
    }
    
    .menu-toggle {
      display: none;
      background: none;
      border: none;
      color: #2e7d32;
      font-size: 20px;
      cursor: pointer;
    }
    
    .mobile-nav {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: rgba(12, 12, 12, 0.95);
      width: 200px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 100;
    }
    
    .mobile-nav a {
      display: block;
      color: #2e7d32;
      text-decoration: none;
      padding: 8px 10px;
      margin-bottom: 5px;
      border-radius: 4px;
    }
    
    .mobile-nav a:hover {
      background: rgba(232, 245, 233, 0.3);
    }
    
    .section {
      padding: 20px;
      background: rgba(255, 255, 255, 0.8);
      margin: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
      backdrop-filter: blur(2px);
      transition: all 0.3s ease;
    }
    
    .section:hover {
      background: rgba(255, 255, 255, 0.9);
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .section-header h2 {
      color: #2e7d32;
    }
    
    .settings-container {
      max-width: 1000px;
      margin: 15px auto;
      padding: 0 15px 60px;
    }
    
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 15px;
    }
    
    .settings-card {
      background: rgba(255, 255, 255, 0.8);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    
    .settings-card:hover {
      transform: translateY(-5px);
    }
    
    .settings-card h3 {
      color: #2e7d32;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(46, 125, 50, 0.3);
      font-size: 18px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #333;
      font-size: 14px;
    }
    
    .form-group input, 
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.9);
      font-size: 14px;
    }
    
    .form-row {
      display: flex;
      gap: 10px;
    }
    
    .form-row .form-group {
      flex: 1;
    }
    
    .btn {
      padding: 10px 15px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      font-size: 14px;
    }
    
    .btn-primary {
      background: #2e7d32;
      color: white;
    }
    
    .btn-primary:hover {
      background: #1b5e20;
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid #2e7d32;
      color: #2e7d32;
    }
    
    .btn-outline:hover {
      background: rgba(46, 125, 50, 0.1);
    }
    
    .btn-danger {
      background: #c62828;
      color: white;
    }
    
    .btn-danger:hover {
      background: #8e0000;
    }
    
    .security-notice {
      background: rgba(46, 125, 50, 0.1);
      padding: 12px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #2e7d32;
      font-size: 14px;
    }
    
    .status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .status-success {
      background: rgba(46, 125, 50, 0.2);
      color: #2e7d32;
    }
    
    .status-warning {
      background: rgba(255, 193, 7, 0.2);
      color: #ffa000;
    }
    
    .status-danger {
      background: rgba(198, 40, 40, 0.2);
      color: #c62828;
    }
    
    .kyc-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .document-upload {
      border: 2px dashed #ddd;
      padding: 15px;
      text-align: center;
      border-radius: 8px;
      margin-bottom: 12px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .document-upload:hover {
      border-color: #2e7d32;
    }
    
    .document-preview {
      max-width: 100%;
      max-height: 200px;
      margin-top: 8px;
      display: none;
    }
    
    /* Auth required message */
    .auth-required-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: calc(100vh - 120px);
      padding: 20px;
    }
    
    .auth-required {
      background: rgba(255, 255, 255, 0.85);
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 500px;
      width: 100%;
      text-align: center;
      backdrop-filter: blur(2px);
    }
    
    .auth-required h2 {
      color: #2e7d32;
      margin-bottom: 15px;
      font-size: 22px;
    }
    
    .auth-required p {
      color: #333;
      margin-bottom: 25px;
      line-height: 1.5;
    }
    
    .auth-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      overflow-y: auto;
    }
    
    .modal-content {
      background: rgba(255,255,255,0.95);
      margin: 10% auto;
      padding: 15px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    .close-modal {
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: #2e7d32;
    }
    
    /* Success message */
    .success-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      z-index: 1001;
      text-align: center;
      display: none;
      max-width: 350px;
      width: 90%;
    }
    
    .success-message h3 {
      color: #2e7d32;
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .success-message p {
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    .success-message button {
      padding: 8px 15px;
      background: #2e7d32;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    /* Error message */
    .error-message {
      position: fixed;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #c62828;
      color: white;
      padding: 8px 15px;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1001;
      display: none;
      animation: fadeInOut 3s ease-in-out;
      font-size: 14px;
      max-width: 90%;
      text-align: center;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; top: 0; }
      10% { opacity: 1; top: 15px; }
      90% { opacity: 1; top: 15px; }
      100% { opacity: 0; top: 0; }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      .settings-grid {
        grid-template-columns: 1fr;
      }
      
      .settings-container {
        padding: 0 10px;
        margin-top: 10px;
      }
      
      .nav {
        display: none;
      }
      
      .menu-toggle {
        display: block;
      }
      
      .mobile-nav.show {
        display: block;
      }
      
      .section {
        padding: 15px;
        margin: 10px;
      }
      
      .settings-card {
        padding: 15px;
      }
      
      .auth-buttons {
        flex-direction: column;
        gap: 10px;
      }
      
      .auth-buttons .btn {
        width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      .logo-title h1 {
        font-size: 16px;
      }
      
      .logo-title video {
        width: 30px;
        height: 30px;
        margin-right: 8px;
      }
      
      header {
        padding: 6px 10px;
      }
      
      .settings-card h3 {
        font-size: 16px;
      }
      
      .auth-required {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="background-container">
    <video autoplay muted loop playsinline>
      <source src="https://dl.dropboxusercontent.com/scl/fi/grduhrszolyx2ipyvjm64/Logo.mp4?rlkey=z9xijvc8x9cpjs7o2dq3r533b&st=iuyj95p2" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <!-- Error Message -->
  <div class="error-message" id="errorMessage"></div>

  <header>
    <div class="logo-title">
      <video autoplay muted loop>
        <source src="https://dl.dropboxusercontent.com/scl/fi/grduhrszolyx2ipyvjm64/Logo.mp4?rlkey=z9xijvc8x9cpjs7o2dq3r533b&st=iuyj95p2" type="video/mp4">
      </video>
      <h1 onclick="window.location.href='index.html'">Crypto Trading Market</h1>
    </div>
    <div class="nav">
      <a href="dashboard.html">Dashboard</a>
      <a href="index.html">Home</a>
      <a href="account.html">Account</a>
      <a href="settings.html" style="background: rgba(232, 245, 233, 0.3);">Settings</a>
      <a href="javascript:void(0)" id="authButton" onclick="handleAuthAction()">Login</a>
    </div>
    <button class="menu-toggle" onclick="toggleMobileMenu()">☰</button>
    <div class="mobile-nav" id="mobileNav">
      <a href="dashboard.html">Dashboard</a>
      <a href="index.html">Home</a>
      <a href="account.html">Account</a>
      <a href="settings.html" style="background: rgba(232, 245, 233, 0.3);">Settings</a>
      <a href="javascript:void(0)" id="mobileAuthButton" onclick="handleAuthAction()">Login</a>
    </div>
  </header>

  <!-- Main Content - Will be shown only when authenticated -->
  <div class="settings-container" id="settingsContent" style="display: none;">
    <div class="settings-grid">
      <!-- Account Settings Card -->
      <div class="settings-card">
        <h3>Account Settings</h3>
        
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="userEmail" readonly>
        </div>
        
        <div class="form-group">
          <label>Account Status</label>
          <div style="display: flex; align-items: center; gap: 10px;">
            <span class="status" id="accountStatus">Verified</span>
            <span style="font-size: 0.9rem; color: #666;">Last login: <span id="lastLogin"></span></span>
          </div>
        </div>
        
        <div class="form-group">
          <label>Account Creation Date</label>
          <input type="text" id="accountCreated" readonly>
        </div>
        
        <div class="security-notice">
          <h4>Security Notice</h4>
          <p>For your security, please ensure your account information is kept up to date and never share your password with anyone.</p>
        </div>
        
        <div class="form-group">
          <button class="btn btn-primary" onclick="logoutUser()">Logout</button>
        </div>
      </div>
      
      <!-- KYC Verification Card -->
      <div class="settings-card">
        <h3>KYC Verification</h3>
        
        <div class="kyc-status">
          <span class="status" id="kycStatusDisplay">Pending Verification</span>
          <span style="font-size: 0.9rem; color: #666;" id="kycStatusText">Complete KYC for full access</span>
        </div>
        
        <div class="form-group">
          <label>Full Legal Name</label>
          <input type="text" id="kycName" placeholder="As shown on your ID">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Date of Birth</label>
            <input type="date" id="kycDob">
          </div>
          <div class="form-group">
            <label>Country</label>
            <select id="kycCountry">
              <option value="">Select Country</option>
              <option value="US">United States</option>
              <option value="GB">United Kingdom</option>
              <option value="CA">Canada</option>
              <option value="AU">Australia</option>
              <option value="DE">Germany</option>
              <option value="FR">France</option>
              <option value="JP">Japan</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label>Address</label>
          <input type="text" id="kycAddress1" placeholder="Street address">
          <input type="text" id="kycAddress2" placeholder="Apartment, suite, etc." style="margin-top: 8px;">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>City</label>
            <input type="text" id="kycCity">
          </div>
          <div class="form-group">
            <label>Postal Code</label>
            <input type="text" id="kycPostalCode">
          </div>
        </div>
        
        <div class="form-group">
          <label>ID Document Type</label>
          <select id="kycIdType">
            <option value="">Select Document Type</option>
            <option value="passport">Passport</option>
            <option value="drivers_license">Driver's License</option>
            <option value="national_id">National ID</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ID Document Number</label>
          <input type="text" id="kycIdNumber" placeholder="Document number">
        </div>
        
        <div class="form-group">
          <label>Upload ID Document (Front)</label>
          <div class="document-upload" onclick="document.getElementById('kycIdFront').click()">
            <p>Click to upload or drag and drop</p>
            <p style="font-size: 0.8rem; color: #666;">JPG, PNG or PDF (Max 5MB)</p>
            <img id="kycIdFrontPreview" class="document-preview">
          </div>
          <input type="file" id="kycIdFront" accept="image/*,.pdf" style="display: none;" onchange="previewDocument('kycIdFront', 'kycIdFrontPreview')">
        </div>
        
        <div class="form-group">
          <label>Upload ID Document (Back)</label>
          <div class="document-upload" onclick="document.getElementById('kycIdBack').click()">
            <p>Click to upload or drag and drop</p>
            <p style="font-size: 0.8rem; color: #666;">JPG, PNG or PDF (Max 5MB)</p>
            <img id="kycIdBackPreview" class="document-preview">
          </div>
          <input type="file" id="kycIdBack" accept="image/*,.pdf" style="display: none;" onchange="previewDocument('kycIdBack', 'kycIdBackPreview')">
        </div>
        
        <div class="form-group">
          <label>Selfie with ID and Note</label>
          <div class="document-upload" onclick="document.getElementById('kycSelfie').click()">
            <p>Click to upload or drag and drop</p>
            <p style="font-size: 0.8rem; color: #666;">JPG or PNG (Max 5MB)</p>
            <img id="kycSelfiePreview" class="document-preview">
          </div>
          <input type="file" id="kycSelfie" accept="image/*" style="display: none;" onchange="previewDocument('kycSelfie', 'kycSelfiePreview')">
          <p style="font-size: 0.8rem; color: #666;">Hold your ID next to your face with a note saying "Crypto Trading Market" and today's date</p>
        </div>
        
        <div class="form-group">
          <button class="btn btn-primary" onclick="submitKyc()">Submit Verification</button>
        </div>
      </div>
      
      <!-- Password Change Card -->
      <div class="settings-card">
        <h3>Change Password</h3>
        
        <div class="form-group">
          <label>Current Password</label>
          <input type="password" id="currentPassword" placeholder="Enter your current password">
        </div>
        
        <div class="form-group">
          <label>New Password</label>
          <input type="password" id="newPassword" placeholder="Enter your new password">
        </div>
        
        <div class="form-group">
          <label>Confirm New Password</label>
          <input type="password" id="confirmPassword" placeholder="Confirm your new password">
        </div>
        
        <div class="form-group">
          <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
        </div>
        
        <div style="font-size: 0.9rem; color: #666; margin-top: 10px;">
          Password requirements: Minimum 8 characters, at least one uppercase letter, one number, and one special character.
        </div>
      </div>
      
      <!-- Preferences Card -->
      <div class="settings-card">
        <h3>Preferences</h3>
        
        <div class="form-group">
          <label>Preferred Currency</label>
          <select id="preferredCurrency">
            <option value="USD">US Dollar (USD)</option>
            <option value="EUR">Euro (EUR)</option>
            <option value="GBP">British Pound (GBP)</option>
            <option value="JPY">Japanese Yen (JPY)</option>
            <option value="BTC">Bitcoin (BTC)</option>
            <option value="ETH">Ethereum (ETH)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Language</label>
          <select id="languagePreference">
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="zh">Chinese</option>
            <option value="ja">Japanese</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Theme</label>
          <select id="themePreference">
            <option value="light">Light Theme</option>
            <option value="dark">Dark Theme</option>
            <option value="system">System Default</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="emailNotifications"> Email Notifications
          </label>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="smsNotifications"> SMS Notifications
          </label>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="twoFactorAuth"> Two-Factor Authentication (2FA)
          </label>
        </div>
        
        <div class="form-group">
          <button class="btn btn-primary" onclick="savePreferences()">Save Preferences</button>
        </div>
      </div>
      
      <!-- Advanced Settings Card -->
      <div class="settings-card">
        <h3>Advanced Settings</h3>
        
        <div class="form-group">
          <label>API Key</label>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="apiKey" readonly>
            <button class="btn btn-outline" onclick="regenerateApiKey()">Regenerate</button>
          </div>
          <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">
            Keep your API key secure. Do not share it with anyone.
          </p>
        </div>
        
        <div class="form-group">
          <label>Export Account Data</label>
          <button class="btn btn-outline" onclick="exportAccountData()">Request Data Export</button>
          <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">
            You can request a complete export of your account data.
          </p>
        </div>
        
        <div class="form-group">
          <label>Delete Account</label>
          <button class="btn btn-danger" onclick="showDeleteAccountModal()">Delete Account</button>
          <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">
            Warning: This action is irreversible and will permanently delete all your data.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Authentication Required Message - Shown when not logged in -->
  <div class="auth-required-container" id="authRequiredMessage">
    <div class="auth-required">
      <h2>Authentication Required</h2>
      <p>To access your account settings, please sign in to your Crypto Trading Market account. If you don't have an account yet, you can create one in just a few minutes.</p>
      <div class="auth-buttons">
        <button class="btn btn-primary" onclick="window.location.href='login.html'">Login</button>
        <button class="btn btn-outline" onclick="window.location.href='signup.html'">Create Account</button>
      </div>
    </div>
  </div>

  <footer>
    © 2025 Crypto Trading Market. All Rights Reserved
  </footer>

  <!-- Delete Account Modal -->
  <div id="deleteAccountModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal('deleteAccountModal')">&times;</span>
      <h2>Delete Account</h2>
      
      <div style="margin-bottom: 20px;">
        <p>Are you sure you want to delete your account? This action cannot be undone.</p>
        <p style="color: #c62828; font-weight: bold; margin-top: 10px;">
          All your data, including transaction history and balances, will be permanently deleted.
        </p>
      </div>
      
      <div class="form-group">
        <label>Enter your password to confirm</label>
        <input type="password" id="deleteAccountPassword" placeholder="Enter your password">
      </div>
      
      <div class="form-group">
        <button class="btn btn-danger" onclick="deleteAccount()">Permanently Delete Account</button>
      </div>
    </div>
  </div>

  <!-- Success Message -->
  <div class="success-message" id="successMessage">
    <h3 id="successTitle">Success!</h3>
    <p id="successText"></p>
    <button onclick="closeSuccess()">Continue</button>
  </div>

  <script>
    // API base URL
    const API_BASE_URL = 'https://website-backendd-1.onrender.com/api/v1';
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', async () => {
      await checkAuth();
      
      // Ensure video plays on mobile
      const videos = document.querySelectorAll('video');
      videos.forEach(video => {
        video.setAttribute('playsinline', '');
        video.setAttribute('webkit-playsinline', '');
        video.play().catch(e => console.log('Video play prevented:', e));
      });
    });

    // Toggle mobile menu
    function toggleMobileMenu() {
      const mobileNav = document.getElementById('mobileNav');
      mobileNav.classList.toggle('show');
    }

    // Handle auth button action
    function handleAuthAction() {
      const token = localStorage.getItem('token');
      if (token) {
        logoutUser();
      } else {
        window.location.href = 'login.html';
      }
    }

    // Check authentication status
    async function checkAuth() {
      const token = localStorage.getItem('token');
      
      // Update auth buttons based on login status
      updateAuthButtons(!!token);
      
      if (!token) {
        // Show auth required message and hide settings content
        document.getElementById('authRequiredMessage').style.display = 'flex';
        document.getElementById('settingsContent').style.display = 'none';
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/auth/status`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          // User is authenticated, show settings content
          document.getElementById('authRequiredMessage').style.display = 'none';
          document.getElementById('settingsContent').style.display = 'block';
          
          // Load user data and settings
          await loadUserData();
          await loadUserSettings();
        } else {
          // Invalid token, show auth required
          localStorage.removeItem('token');
          document.getElementById('authRequiredMessage').style.display = 'flex';
          document.getElementById('settingsContent').style.display = 'none';
          updateAuthButtons(false);
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        // Network error, still show auth required
        document.getElementById('authRequiredMessage').style.display = 'flex';
        document.getElementById('settingsContent').style.display = 'none';
        updateAuthButtons(false);
      }
    }

    // Update auth buttons based on login status
    function updateAuthButtons(isLoggedIn) {
      if (isLoggedIn) {
        document.getElementById('authButton').textContent = 'Logout';
        document.getElementById('mobileAuthButton').textContent = 'Logout';
      } else {
        document.getElementById('authButton').textContent = 'Login';
        document.getElementById('mobileAuthButton').textContent = 'Login';
      }
    }

    // Load user data from backend
    async function loadUserData() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/users/me`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          const user = data.data.user;
          
          // Update form fields
          document.getElementById('userEmail').value = user.email;
          document.getElementById('accountCreated').value = new Date(user.createdAt).toLocaleDateString();
          
          // Update account status
          const accountStatusElement = document.getElementById('accountStatus');
          accountStatusElement.textContent = user.isVerified ? 'Verified' : 'Unverified';
          accountStatusElement.className = user.isVerified ? 'status status-success' : 'status status-warning';
          
          // Update KYC status
          updateKYCStatus(user.kycStatus || 'unverified');
          
          // Update last login
          if (user.lastLogin) {
            document.getElementById('lastLogin').textContent = new Date(user.lastLogin).toLocaleString();
          }
          
          // Populate KYC fields if they exist
          if (user.kycDetails) {
            document.getElementById('kycName').value = user.kycDetails.fullName || '';
            document.getElementById('kycDob').value = user.kycDetails.dob || '';
            document.getElementById('kycCountry').value = user.kycDetails.country || '';
            document.getElementById('kycAddress1').value = user.kycDetails.address || '';
            document.getElementById('kycCity').value = user.kycDetails.city || '';
            document.getElementById('kycPostalCode').value = user.kycDetails.postalCode || '';
            document.getElementById('kycIdType').value = user.kycDetails.idType || '';
            document.getElementById('kycIdNumber').value = user.kycDetails.idNumber || '';
          }
        } else {
          showError('Failed to load user data');
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        showError('Network error loading user data');
      }
    }

    // Load user settings from backend
    async function loadUserSettings() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/users/settings`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const settings = await response.json();
          
          // Update form fields
          document.getElementById('preferredCurrency').value = settings.preferredCurrency || 'USD';
          document.getElementById('languagePreference').value = settings.language || 'en';
          document.getElementById('themePreference').value = settings.theme || 'light';
          document.getElementById('emailNotifications').checked = settings.emailNotifications !== false;
          document.getElementById('smsNotifications').checked = settings.smsNotifications || false;
          document.getElementById('twoFactorAuth').checked = settings.twoFactorAuth || false;
          
          // Update API key if exists
          if (settings.apiKey) {
            document.getElementById('apiKey').value = settings.apiKey;
          }
          
          // Apply theme if set
          if (settings.theme === 'dark') {
            document.body.style.backgroundColor = '#121212';
            document.body.style.color = '#ffffff';
          }
        }
      } catch (error) {
        console.error('Error loading settings:', error);
      }
    }

    // Update KYC status display
    function updateKYCStatus(status) {
      const kycStatusElement = document.getElementById('kycStatusDisplay');
      const kycStatusTextElement = document.getElementById('kycStatusText');
      
      if (status === 'verified') {
        kycStatusElement.textContent = 'Verified';
        kycStatusElement.className = 'status status-success';
        kycStatusTextElement.textContent = 'Your account is fully verified';
      } else if (status === 'pending') {
        kycStatusElement.textContent = 'Pending Verification';
        kycStatusElement.className = 'status status-warning';
        kycStatusTextElement.textContent = 'Verification in progress';
      } else if (status === 'rejected') {
        kycStatusElement.textContent = 'Verification Rejected';
        kycStatusElement.className = 'status status-danger';
        kycStatusTextElement.textContent = 'Please correct and resubmit your documents';
      } else {
        kycStatusElement.textContent = 'Not Verified';
        kycStatusElement.className = 'status status-warning';
        kycStatusTextElement.textContent = 'Complete KYC for full access';
      }
    }

    // Preview uploaded document
    function previewDocument(inputId, previewId) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      
      if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          showError('File size exceeds 5MB limit');
          input.value = '';
          return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        }
        
        reader.readAsDataURL(file);
      }
    }

    // Submit KYC verification
    async function submitKyc() {
      const name = document.getElementById('kycName').value;
      const dob = document.getElementById('kycDob').value;
      const country = document.getElementById('kycCountry').value;
      const address1 = document.getElementById('kycAddress1').value;
      const city = document.getElementById('kycCity').value;
      const postalCode = document.getElementById('kycPostalCode').value;
      const idType = document.getElementById('kycIdType').value;
      const idNumber = document.getElementById('kycIdNumber').value;
      const idFront = document.getElementById('kycIdFront').files[0];
      const idBack = document.getElementById('kycIdBack').files[0];
      const selfie = document.getElementById('kycSelfie').files[0];
      
      // Basic validation
      if (!name || !dob || !country || !address1 || !city || !postalCode || !idType || !idNumber || !idFront || !selfie) {
        showError('Please fill in all required fields and upload all required documents');
        return;
      }
      
      try {
        const token = localStorage.getItem('token');
        const formData = new FormData();
        
        formData.append('fullName', name);
        formData.append('dob', dob);
        formData.append('country', country);
        formData.append('address', address1);
        if (document.getElementById('kycAddress2').value) {
          formData.append('address2', document.getElementById('kycAddress2').value);
        }
        formData.append('city', city);
        formData.append('postalCode', postalCode);
        formData.append('idType', idType);
        formData.append('idNumber', idNumber);
        formData.append('idFront', idFront);
        if (idBack) formData.append('idBack', idBack);
        formData.append('selfie', selfie);
        
        const response = await fetch(`${API_BASE_URL}/users/kyc`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });
        
        if (response.ok) {
          const data = await response.json();
          updateKYCStatus(data.kycStatus);
          showSuccessMessage('KYC Submitted', 'Your verification documents have been submitted successfully. Verification typically takes 1-3 business days.');
        } else {
          const error = await response.json();
          showError(error.message || 'KYC submission failed');
        }
      } catch (error) {
        console.error('KYC submission error:', error);
        showError('Network error during KYC submission');
      }
    }

    // Change password
    async function changePassword() {
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (!currentPassword || !newPassword || !confirmPassword) {
        showError('Please fill in all password fields');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showError('New passwords do not match');
        return;
      }
      
      if (newPassword.length < 8) {
        showError('Password must be at least 8 characters long');
        return;
      }
      
      if (!/[A-Z]/.test(newPassword) || !/[0-9]/.test(newPassword) || !/[^A-Za-z0-9]/.test(newPassword)) {
        showError('Password must contain at least one uppercase letter, one number, and one special character');
        return;
      }
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/auth/update-password`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            currentPassword,
            newPassword,
            newPasswordConfirm: confirmPassword
          })
        });
        
        if (response.ok) {
          // Clear password fields
          document.getElementById('currentPassword').value = '';
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmPassword').value = '';
          
          showSuccessMessage('Password Changed', 'Your password has been updated successfully.');
        } else {
          const error = await response.json();
          showError(error.message || 'Password change failed');
        }
      } catch (error) {
        console.error('Password change error:', error);
        showError('Network error during password change');
      }
    }

    // Save preferences
    async function savePreferences() {
      const preferences = {
        preferredCurrency: document.getElementById('preferredCurrency').value,
        language: document.getElementById('languagePreference').value,
        theme: document.getElementById('themePreference').value,
        emailNotifications: document.getElementById('emailNotifications').checked,
        smsNotifications: document.getElementById('smsNotifications').checked,
        twoFactorAuth: document.getElementById('twoFactorAuth').checked
      };
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/users/settings`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(preferences)
        });
        
        if (response.ok) {
          showSuccessMessage('Preferences Saved', 'Your settings have been updated successfully.');
          
          // Apply theme if changed
          if (preferences.theme === 'dark') {
            document.body.style.backgroundColor = '#121212';
            document.body.style.color = '#ffffff';
          } else if (preferences.theme === 'light') {
            document.body.style.backgroundColor = '#ffffff';
            document.body.style.color = '#0c0b0b';
          }
        } else {
          const error = await response.json();
          showError(error.message || 'Failed to save preferences');
        }
      } catch (error) {
        console.error('Error saving preferences:', error);
        showError('Network error saving preferences');
      }
    }

    // Regenerate API key
    async function regenerateApiKey() {
      if (!confirm('Are you sure you want to regenerate your API key? Any applications using the current key will stop working.')) {
        return;
      }
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/users/generate-api-key`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          document.getElementById('apiKey').value = data.apiKey;
          showSuccessMessage('API Key Regenerated', 'Your new API key has been generated successfully. Update any applications using the previous key.');
        } else {
          const error = await response.json();
          showError(error.message || 'Failed to regenerate API key');
        }
      } catch (error) {
        console.error('API key regeneration error:', error);
        showError('Network error during API key regeneration');
      }
    }

    // Export account data
    async function exportAccountData() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/users/export-data`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          showSuccessMessage('Export Requested', 'Your account data export has been requested. You will receive an email with download instructions when it is ready.');
        } else {
          const error = await response.json();
          showError(error.message || 'Failed to request data export');
        }
      } catch (error) {
        console.error('Data export error:', error);
        showError('Network error during data export request');
      }
    }

    // Show delete account modal
    function showDeleteAccountModal() {
      document.getElementById('deleteAccountModal').style.display = 'block';
    }

    // Delete account
    async function deleteAccount() {
      const password = document.getElementById('deleteAccountPassword').value;
      
      if (!password) {
        showError('Please enter your password to confirm');
        return;
      }
      
      if (!confirm('This will permanently delete your account and all associated data. Are you absolutely sure?')) {
        return;
      }
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/users/delete-account`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password })
        });
        
        if (response.ok) {
          // Clear local storage
          localStorage.removeItem('token');
          
          showSuccessMessage('Account Deleted', 'Your account has been permanently deleted. Redirecting to home page...');
          
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 3000);
        } else {
          const error = await response.json();
          showError(error.message || 'Account deletion failed');
        }
      } catch (error) {
        console.error('Account deletion error:', error);
        showError('Network error during account deletion');
      }
    }

    // Logout user
    async function logoutUser() {
      try {
        const token = localStorage.getItem('token');
        if (token) {
          await fetch(`${API_BASE_URL}/auth/logout`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
        }
        
        // Clear local storage
        localStorage.removeItem('token');
        
        // Update UI
        updateAuthButtons(false);
        document.getElementById('authRequiredMessage').style.display = 'flex';
        document.getElementById('settingsContent').style.display = 'none';
        
        showSuccessMessage('Logged Out', 'You have been successfully logged out.');
      } catch (error) {
        console.error('Logout error:', error);
        // Still proceed with logout even if API call fails
        localStorage.removeItem('token');
        updateAuthButtons(false);
        document.getElementById('authRequiredMessage').style.display = 'flex';
        document.getElementById('settingsContent').style.display = 'none';
      }
    }

    // Show error message
    function showError(message) {
      const errorElement = document.getElementById('errorMessage');
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      
      setTimeout(() => {
        errorElement.style.display = 'none';
      }, 3000);
    }

    // Show success message
    function showSuccessMessage(title, text) {
      document.getElementById('successTitle').textContent = title;
      document.getElementById('successText').textContent = text;
      document.getElementById('successMessage').style.display = 'block';
    }

    // Close success message
    function closeSuccess() {
      document.getElementById('successMessage').style.display = 'none';
    }

    // Close modal
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    // Auth check for all pages
(async function checkAuth() {
  try {
    const response = await fetch('/api/v1/auth/status');
    const data = await response.json();
    
    if (!data.isAuthenticated && !window.location.pathname.includes('login.html')) {
      window.location.href = 'login.html';
    }
    
    // Optional: Update UI with user data
    if (data.isAuthenticated) {
      console.log('Logged in as:', data.user.email || data.user.walletAddress);
    }
  } catch (error) {
    console.error('Auth check failed:', error);
    window.location.href = 'login.html';
  }
})();
  </script>
</body>
</html>
