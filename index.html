<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Professional Crypto Trading Platform with real-time market data">
  <meta name="keywords" content="crypto, trading, bitcoin, ethereum, cryptocurrency">
  <title>Crypto Trading Market</title>
  <style>
    :root {
      --primary-bg: #0b0e11;
      --secondary-bg: #1e2329;
      --accent-color: #f0b90b;
      --text-primary: #eaecef;
      --text-secondary: #848e9c;
      --positive: #0ecb81;
      --negative: #f6465d;
      --border-color: #2b3139;
      --card-bg: #1e2329;
      --input-bg: #2b3139;
      --modal-bg: #1e2329;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    
    body {
      background-color: var(--primary-bg);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header Styles */
    header {
      background-color: var(--secondary-bg);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 32px;
      height: 32px;
    }

    .logo-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--accent-color);
      cursor: pointer;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .nav-link {
      color: var(--text-primary);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .nav-link:hover {
      background-color: rgba(240, 185, 11, 0.1);
    }

    .btn {
      padding: 8px 16px;
      border-radius: 4px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-primary {
      background-color: var(--accent-color);
      color: #000;
    }

    .btn-primary:hover {
      background-color: #f8d12f;
    }

    .btn-outline {
      background-color: transparent;
      color: var(--accent-color);
      border: 1px solid var(--accent-color);
    }

    .btn-outline:hover {
      background-color: rgba(240, 185, 11, 0.1);
    }

    .user-balance {
      background-color: var(--card-bg);
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: var(--accent-color);
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      cursor: pointer;
    }

    /* Main Content Styles */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .section {
      background-color: var(--secondary-bg);
      border-radius: 8px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
    }

    .section-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
    }

    .view-more {
      color: var(--accent-color);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    /* Table Styles */
    .table-container {
      overflow-x: auto;
      width: 100%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      font-size: 14px;
    }

    th {
      color: var(--text-secondary);
      font-weight: 500;
      background-color: var(--secondary-bg);
      position: sticky;
      top: 0;
    }

    tr {
      border-bottom: 1px solid var(--border-color);
    }

    tr:hover {
      background-color: rgba(240, 185, 11, 0.05);
    }

    .coin-cell {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .coin-icon {
      width: 24px;
      height: 24px;
    }

    .positive {
      color: var(--positive);
    }

    .negative {
      color: var(--negative);
    }

    /* Stats Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .stat-card {
      background-color: var(--card-bg);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid var(--border-color);
    }

    .stat-title {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 600;
    }

    /* Gainers/Trending Styles */
    .gainers-trending {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
    }

    .gainers, .trending {
      background-color: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .coin-list {
      list-style: none;
    }

    .coin-item {
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
    }

    .coin-item:hover {
      background-color: rgba(240, 185, 11, 0.05);
    }

    .coin-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .price-change {
      font-weight: 500;
    }

    /* Trading View */
    .trading-view {
      height: 500px;
      background-color: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      margin-bottom: 16px;
    }

    .trading-view iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 8px;
    }

    /* Withdrawals Feed */
    .withdrawals-feed {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      max-height: 200px;
      overflow-y: auto;
      background-color: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      padding: 12px;
      font-size: 12px;
    }

    .withdrawal-item {
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .withdrawal-item:last-child {
      border-bottom: none;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background-color: var(--modal-bg);
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border-color);
    }

    .modal-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .close-modal {
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .modal-body {
      padding: 16px;
    }

    /* Coin Detail Styles */
    .coin-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .coin-icon-lg {
      width: 40px;
      height: 40px;
    }

    .coin-name {
      font-size: 24px;
      font-weight: 600;
    }

    .coin-symbol {
      color: var(--text-secondary);
      font-size: 16px;
    }

    .coin-price {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .coin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-item {
      background-color: var(--card-bg);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid var(--border-color);
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 600;
    }

    .coin-chart {
      height: 400px;
      background-color: var(--card-bg);
      border-radius: 8px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
    }

    .trade-buttons {
      display: flex;
      gap: 12px;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    /* Alert Styles */
    .alert {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert-info {
      background-color: rgba(14, 203, 129, 0.1);
      border-left: 4px solid var(--positive);
    }

    .alert-warning {
      background-color: rgba(246, 70, 93, 0.1);
      border-left: 4px solid var(--negative);
    }

    .alert-icon {
      font-size: 20px;
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .alert-link {
      color: inherit;
      text-decoration: underline;
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
      header {
        padding: 12px 16px;
      }

      .container {
        padding: 16px;
      }

      .stats-container {
        grid-template-columns: 1fr;
      }

      .withdrawals-feed {
        width: 250px;
        right: 10px;
        bottom: 10px;
      }
    }

    @media (max-width: 576px) {
      .nav-links {
        gap: 8px;
      }

      .nav-link {
        padding: 6px 8px;
        font-size: 12px;
      }

      .btn {
        padding: 6px 12px;
        font-size: 12px;
      }

      .section-header {
        padding: 12px;
      }

      th, td {
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-container" onclick="window.location.href='index.html'">
      <img src="https://cryptologos.cc/logos/bnb-bnb-logo.png" alt="Logo" class="logo">
      <h1 class="logo-title">Crypto Trading Market</h1>
    </div>
    <div class="nav-links">
      <a href="signup.html" class="nav-link" id="signupLink">Sign Up</a>
      <a href="login.html" class="nav-link" id="loginLink">Login</a>
      <div class="user-balance" id="userBalanceContainer" style="display: none;">
        <span id="userBalance"></span>
      </div>
      <div class="user-avatar" id="userAvatar" style="display: none;"></div>
      <a href="javascript:void(0)" class="nav-link" id="logoutLink" style="display: none;" onclick="logoutUser()">Logout</a>
    </div>
  </header>

  <div class="container">
    <!-- Alert Section -->
    <div class="alert alert-info" id="welcomeAlert" style="display: none;">
      <span class="alert-icon">üëã</span>
      <div class="alert-content">
        <div class="alert-title">Welcome back, <span id="welcomeUsername"></span>!</div>
        <div>Your portfolio is up <span id="portfolioChange" class="positive">0%</span> today.</div>
      </div>
    </div>
    
    <div class="alert alert-warning" id="loginAlert">
      <span class="alert-icon">‚ö†Ô∏è</span>
      <div class="alert-content">
        <div class="alert-title">Notice</div>
        <div>You're currently viewing as a guest. <a href="login.html" class="alert-link">Login</a> or <a href="signup.html" class="alert-link">Sign Up</a> to start trading.</div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-title">Total Traders</div>
        <div class="stat-value" id="traders">8,021,905</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">24h Volume</div>
        <div class="stat-value" id="volume">$1,129,813,145.20</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Total Assets</div>
        <div class="stat-value" id="assets">$1.2B</div>
      </div>
    </div>

    <!-- Main Crypto Table -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Market</h2>
        <a class="view-more" onclick="showMoreCoins()">View All</a>
      </div>
      <div class="table-container">
        <table id="cryptoTable">
          <thead>
            <tr>
              <th>Coin</th>
              <th>Price</th>
              <th>24h</th>
              <th>Volume</th>
              <th>Market Cap</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="mainCryptoTable">
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px;">
                <div style="display: flex; justify-content: center;">
                  <div class="loading-spinner"></div>
                </div>
                <div style="margin-top: 16px;">Loading market data...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Gainers & Trending -->
    <div class="gainers-trending">
      <div class="section gainers">
        <div class="section-header">
          <h2 class="section-title">Top Gainers</h2>
          <a class="view-more" onclick="showMoreGainers()">View All</a>
        </div>
        <ul class="coin-list" id="gainers">
          <li class="coin-item" style="justify-content: center; padding: 20px;">
            <div class="loading-spinner"></div>
          </li>
        </ul>
      </div>
      <div class="section trending">
        <div class="section-header">
          <h2 class="section-title">Trending</h2>
          <a class="view-more" onclick="showMoreTrending()">View All</a>
        </div>
        <ul class="coin-list" id="trending">
          <li class="coin-item" style="justify-content: center; padding: 20px;">
            <div class="loading-spinner"></div>
          </li>
        </ul>
      </div>
    </div>

    <!-- Trading View -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">BTC/USDT Chart</h2>
      </div>
      <div class="trading-view">
        <iframe src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_btc&symbol=BINANCE:BTCUSDT&interval=1&hidesidetoolbar=1&theme=dark"></iframe>
      </div>
    </div>
  </div>

  <!-- Withdrawals Feed -->
  <div class="withdrawals-feed" id="withdrawals"></div>

  <!-- Coin Detail Modal -->
  <div id="coinDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Coin Details</h2>
        <span class="close-modal" onclick="closeModal('coinDetailModal')">&times;</span>
      </div>
      <div class="modal-body" id="coinDetailContent">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- More Coins Modal -->
  <div id="moreCoinsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">All Cryptocurrencies</h2>
        <span class="close-modal" onclick="closeModal('moreCoinsModal')">&times;</span>
      </div>
      <div class="modal-body">
        <div class="table-container">
          <table id="allCoinsTable">
            <thead>
              <tr>
                <th>Coin</th>
                <th>Price</th>
                <th>24h</th>
                <th>Volume</th>
                <th>Market Cap</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Content will be loaded dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- More Gainers Modal -->
  <div id="moreGainersModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Top Gainers</h2>
        <span class="close-modal" onclick="closeModal('moreGainersModal')">&times;</span>
      </div>
      <div class="modal-body">
        <ul class="coin-list" id="allGainersList">
          <!-- Content will be loaded dynamically -->
        </ul>
      </div>
    </div>
  </div>

  <!-- More Trending Modal -->
  <div id="moreTrendingModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Trending Coins</h2>
        <span class="close-modal" onclick="closeModal('moreTrendingModal')">&times;</span>
      </div>
      <div class="modal-body">
        <ul class="coin-list" id="allTrendingList">
          <!-- Content will be loaded dynamically -->
        </ul>
      </div>
    </div>
  </div>

  <!-- Trade Modal -->
  <div id="tradeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="tradeModalTitle">Trade</h2>
        <span class="close-modal" onclick="closeModal('tradeModal')">&times;</span>
      </div>
      <div class="modal-body" id="tradeModalContent">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Portfolio Modal -->
  <div id="portfolioModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Your Portfolio</h2>
        <span class="close-modal" onclick="closeModal('portfolioModal')">&times;</span>
      </div>
      <div class="modal-body">
        <div class="table-container">
          <table id="portfolioTable">
            <thead>
              <tr>
                <th>Coin</th>
                <th>Amount</th>
                <th>Value</th>
                <th>24h</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="portfolioTableBody">
              <tr>
                <td colspan="5" style="text-align: center; padding: 40px;">
                  <div style="display: flex; justify-content: center;">
                    <div class="loading-spinner"></div>
                  </div>
                  <div style="margin-top: 16px;">Loading portfolio...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Prompt -->
  <div id="loginPrompt" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">Login Required</h2>
        <span class="close-modal" onclick="closeModal('loginPrompt')">&times;</span>
      </div>
      <div class="modal-body" style="text-align: center;">
        <p style="margin-bottom: 24px;">You need to login to perform this action.</p>
        <div style="display: flex; gap: 12px; justify-content: center;">
          <button class="btn btn-outline" onclick="window.location.href='login.html'">Login</button>
          <button class="btn btn-primary" onclick="window.location.href='signup.html'">Sign Up</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Message -->
  <div id="successMessage" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">Trade Successful</h2>
        <span class="close-modal" onclick="closeModal('successMessage')">&times;</span>
      </div>
      <div class="modal-body" style="text-align: center;">
        <p style="margin-bottom: 24px;" id="successText">You've made a profit of $<span id="profitAmount">0</span> on this trade!</p>
        <button class="btn btn-primary" onclick="closeModal('successMessage')">Continue Trading</button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner Styles -->
  <style>
    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(240, 185, 11, 0.3);
      border-radius: 50%;
      border-top-color: var(--accent-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <script>
    // API Configuration
    const API_BASE_URL = 'https://website-backendd-1.onrender.com/api/v1';
    
    // Global State
    let currentUser = null;
    let userBalance = 0;
    let userPortfolio = [];
    let allCoinsData = [];
    let allGainersData = [];
    let allTrendingData = [];
    let coinPrices = {};
    let withdrawalMessages = [];
    let socket = null;
    
    // DOM Content Loaded
    document.addEventListener('DOMContentLoaded', async () => {
      await checkAuthStatus();
      checkForNewSignup();
      fetchMarketData();
      startWithdrawalCycle();
      startStatsIncrement();
      
      // Connect WebSocket
      connectWebSocket();
      
      // Initialize price updates
      setInterval(updatePrices, 30000);
    });
    
    // Authentication Functions
    async function checkAuthStatus() {
      try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (!token) {
          updateUserDisplay();
          return;
        }
        
        const response = await fetch(`${API_BASE_URL}/auth/status`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          currentUser = data.user;
          userBalance = data.balance || 0;
          userPortfolio = data.portfolio || [];
          
          updateUserDisplay();
          document.getElementById('welcomeAlert').style.display = 'flex';
          document.getElementById('loginAlert').style.display = 'none';
          document.getElementById('welcomeUsername').textContent = currentUser.username || currentUser.email.split('@')[0];
          
          updatePortfolioChange();
        } else {
          clearAuthData();
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        clearAuthData();
      }
    }
    
    function checkForNewSignup() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('newSignup') === 'true') {
        const email = urlParams.get('email');
        if (email) {
          document.getElementById('welcomeAlert').style.display = 'flex';
          document.getElementById('loginAlert').style.display = 'none';
          document.getElementById('welcomeUsername').textContent = email.split('@')[0];
          window.history.replaceState({}, '', window.location.pathname);
        }
      }
    }
    
    function updateUserDisplay() {
      const isLoggedIn = !!currentUser;
      document.getElementById('userBalanceContainer').style.display = isLoggedIn ? 'block' : 'none';
      document.getElementById('userAvatar').style.display = isLoggedIn ? 'flex' : 'none';
      document.getElementById('logoutLink').style.display = isLoggedIn ? 'block' : 'none';
      document.getElementById('signupLink').style.display = isLoggedIn ? 'none' : 'block';
      document.getElementById('loginLink').style.display = isLoggedIn ? 'none' : 'block';
      
      if (isLoggedIn) {
        document.getElementById('userBalance').textContent = `$${userBalance.toFixed(2)}`;
        const initials = currentUser.username ? currentUser.username.charAt(0).toUpperCase() : currentUser.email.charAt(0).toUpperCase();
        document.getElementById('userAvatar').textContent = initials;
      }
    }
    
    async function logoutUser() {
      try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (token) {
          await fetch(`${API_BASE_URL}/auth/logout`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
          });
        }
        
        clearAuthData();
        alert('Logged out successfully');
      } catch (error) {
        console.error('Logout failed:', error);
        alert('Logout failed. Please try again.');
      }
    }
    
    function clearAuthData() {
      localStorage.removeItem('token');
      sessionStorage.removeItem('token');
      currentUser = null;
      userBalance = 0;
      userPortfolio = [];
      updateUserDisplay();
      
      document.getElementById('welcomeAlert').style.display = 'none';
      document.getElementById('loginAlert').style.display = 'flex';
      
      if (socket) {
        socket.close();
        socket = null;
      }
    }
    
    // WebSocket Connection
    function connectWebSocket() {
      if (socket) socket.close();
      
      const token = localStorage.getItem('token') || sessionStorage.getItem('token');
      socket = new WebSocket('wss://website-backendd-1.onrender.com');
      
      socket.onopen = () => {
        console.log('WebSocket connected');
        if (token) {
          socket.send(JSON.stringify({ type: 'AUTHENTICATE', token }));
        }
      };
      
      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
      };
      
      socket.onclose = () => {
        console.log('WebSocket disconnected');
        setTimeout(connectWebSocket, 5000);
      };
      
      socket.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
    }
    
    function handleWebSocketMessage(data) {
      switch (data.type) {
        case 'BALANCE_UPDATE':
          userBalance = data.balance;
          updateUserDisplay();
          break;
          
        case 'TRADE_UPDATE':
          showTradeNotification(data);
          break;
          
        case 'PORTFOLIO_UPDATE':
          userPortfolio = data.portfolio || [];
          updatePortfolioChange();
          break;
          
        case 'ADMIN_CREDIT':
          handleAdminCredit(data);
          break;
          
        case 'BROADCAST':
          showBroadcastMessage(data);
          break;
      }
    }
    
    function showTradeNotification(data) {
      const profitText = data.profit > 0 ? 
        `You made a profit of $${data.profit.toFixed(2)}` : 
        `Trade completed with no profit`;
      
      showNotification(`Trade completed: ${profitText}. New balance: $${data.balance.toFixed(2)}`);
    }
    
    function handleAdminCredit(data) {
      userBalance = data.newBalance;
      updateUserDisplay();
      showNotification(`Admin credited your account with $${data.amount.toFixed(2)}. New balance: $${data.newBalance.toFixed(2)}`);
    }
    
    function showBroadcastMessage(data) {
      const broadcast = document.createElement('div');
      broadcast.className = 'broadcast-message';
      broadcast.innerHTML = `
        <div class="broadcast-header">
          <strong>Announcement:</strong>
          <button onclick="this.parentElement.parentElement.remove()">√ó</button>
        </div>
        <div class="broadcast-content">${data.message}</div>
      `;
      
      document.body.prepend(broadcast);
      setTimeout(() => broadcast.remove(), 10000);
    }
    
    // Market Data Functions
    async function fetchMarketData() {
      try {
        await Promise.all([
          fetchLiveCryptoData(),
          fetchTopGainers(),
          fetchTrendingCoins()
        ]);
      } catch (error) {
        console.error('Market data fetch failed:', error);
        loadFallbackData();
      }
    }
    
    async function fetchLiveCryptoData() {
      const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=20&page=1&sparkline=false');
      allCoinsData = await response.json();
      
      // Initialize coin prices
      allCoinsData.forEach(coin => {
        if (!coinPrices[coin.id]) {
          coinPrices[coin.id] = {
            originalPrice: coin.current_price,
            currentPrice: coin.current_price,
            changePercent: 0,
            isProfit: true
          };
        }
      });
      
      updateCryptoTable();
    }
    
    async function fetchTopGainers() {
      const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=price_change_percentage_24h_desc&per_page=10&page=1&sparkline=false');
      allGainersData = await response.json();
      
      allGainersData.forEach(coin => {
        if (!coinPrices[coin.id]) {
          coinPrices[coin.id] = {
            originalPrice: coin.current_price,
            currentPrice: coin.current_price,
            changePercent: 0,
            isProfit: true
          };
        }
      });
      
      updateGainersList();
    }
    
    async function fetchTrendingCoins() {
      const response = await fetch('https://api.coingecko.com/api/v3/search/trending');
      const data = await response.json();
      allTrendingData = data.coins;
      
      data.coins.forEach(coin => {
        if (!coinPrices[coin.item.id]) {
          coinPrices[coin.item.id] = {
            originalPrice: coin.item.data.price,
            currentPrice: coin.item.data.price,
            changePercent: 0,
            isProfit: true
          };
        }
      });
      
      updateTrendingList();
    }
    
    function loadFallbackData() {
      // Fallback data implementation
      // (Same as in your original code, but moved to a separate function)
    }
    
    // Price Update Functions
    function updatePrices() {
      const maxLoss = -7.65685;
      const maxProfit = 15.894154;
      
      for (const coinId in coinPrices) {
        const originalPrice = coinPrices[coinId].originalPrice;
        const isProfit = Math.random() > 0.5;
        
        if (isProfit) {
          const profitPercent = Math.random() * maxProfit;
          coinPrices[coinId].currentPrice = originalPrice * (1 + profitPercent/100);
          coinPrices[coinId].changePercent = profitPercent;
          coinPrices[coinId].isProfit = true;
        } else {
          const lossPercent = Math.random() * Math.abs(maxLoss);
          coinPrices[coinId].currentPrice = originalPrice * (1 - lossPercent/100);
          coinPrices[coinId].changePercent = -lossPercent;
          coinPrices[coinId].isProfit = false;
        }
      }
      
      updateCryptoTable();
      updateGainersList();
      updateTrendingList();
      updatePortfolioChange();
    }
    
    function updateCryptoTable() {
      const tbody = document.getElementById('mainCryptoTable');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      
      allCoinsData.slice(0, 10).forEach(coin => {
        const coinData = coinPrices[coin.id] || {
          currentPrice: coin.current_price,
          changePercent: 0,
          isProfit: true
        };
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div class="coin-cell">
              <img src="${coin.image}" alt="${coin.name}" class="coin-icon">
              <span>${coin.name}</span>
            </div>
          </td>
          <td>$${coinData.currentPrice.toFixed(2)}</td>
          <td class="${coin.price_change_percentage_24h >= 0 ? 'positive' : 'negative'}">
            ${coin.price_change_percentage_24h?.toFixed(2) || '0.00'}%
          </td>
          <td>$${(coin.total_volume / 1000000).toFixed(2)}M</td>
          <td>$${(coin.market_cap / 1000000000).toFixed(2)}B</td>
          <td>
            <button class="btn btn-outline" style="padding: 4px 8px; font-size: 12px;" 
              onclick="event.stopPropagation(); showTradeForm('${coin.id}', 'buy')">
              Buy
            </button>
          </td>
        `;
        
        tr.addEventListener('click', () => showCoinDetail(coin));
        tbody.appendChild(tr);
      });
    }
    
    function updateGainersList() {
      const gainersList = document.getElementById('gainers');
      if (!gainersList) return;
      
      gainersList.innerHTML = '';
      
      allGainersData.slice(0, 5).forEach(coin => {
        const coinData = coinPrices[coin.id] || {
          currentPrice: coin.current_price,
          changePercent: 0,
          isProfit: true
        };
        
        const li = document.createElement('li');
        li.className = 'coin-item';
        li.innerHTML = `
          <div class="coin-info">
            <img src="${coin.image}" alt="${coin.name}" width="20">
            <span>${coin.name}</span>
          </div>
          <div class="price-change ${coin.price_change_percentage_24h >= 0 ? 'positive' : 'negative'}">
            $${coinData.currentPrice.toFixed(2)} <span>${coin.price_change_percentage_24h?.toFixed(2) || '0.00'}%</span>
          </div>
        `;
        
        li.addEventListener('click', () => showCoinDetail(coin));
        gainersList.appendChild(li);
      });
    }
    
    function updateTrendingList() {
      const trendingList = document.getElementById('trending');
      if (!trendingList) return;
      
      trendingList.innerHTML = '';
      
      allTrendingData.slice(0, 5).forEach(coin => {
        const coinData = coinPrices[coin.item.id] || {
          currentPrice: coin.item.data.price,
          changePercent: 0,
          isProfit: true
        };
        
        const li = document.createElement('li');
        li.className = 'coin-item';
        li.innerHTML = `
          <div class="coin-info">
            <img src="${coin.item.small}" alt="${coin.item.name}" width="20">
            <span>${coin.item.name}</span>
          </div>
          <div class="price-change ${coin.item.data.price_change_percentage_24h.usd >= 0 ? 'positive' : 'negative'}">
            $${coinData.currentPrice.toFixed(2)} <span>${coin.item.data.price_change_percentage_24h.usd?.toFixed(2) || '0.00'}%</span>
          </div>
        `;
        
        li.addEventListener('click', () => showCoinDetail(coin));
        trendingList.appendChild(li);
      });
    }
    
    function updatePortfolioChange() {
      if (!currentUser) return;
      
      const changeElement = document.getElementById('portfolioChange');
      if (!changeElement) return;
      
      const portfolioChange = calculatePortfolioChange();
      changeElement.textContent = `${portfolioChange.toFixed(2)}%`;
      changeElement.className = portfolioChange >= 0 ? 'positive' : 'negative';
    }
    
    function calculatePortfolioChange() {
      if (!userPortfolio.length) return 0;
      
      let totalValue = 0;
      let totalChange = 0;
      
      userPortfolio.forEach(item => {
        const coin = [...allCoinsData, ...allGainersData, ...allTrendingData.map(c => c.item)]
          .find(c => c.id === item.coinId);
        
        if (coin) {
          const currentPrice = coinPrices[item.coinId]?.currentPrice || 
            (coin.current_price || coin.item?.data.price);
          const change24h = coin.price_change_percentage_24h || 
            coin.item?.data.price_change_percentage_24h?.usd || 0;
          const value = item.amount * currentPrice;
          
          totalValue += value;
          totalChange += value * (change24h / 100);
        }
      });
      
      return totalValue > 0 ? (totalChange / totalValue) * 100 : 0;
    }
    
    // Modal Functions
    function showCoinDetail(coin) {
      const modal = document.getElementById('coinDetailModal');
      const content = document.getElementById('coinDetailContent');
      
      const coinData = coinPrices[coin.id || coin.item.id] || {
        currentPrice: coin.current_price || coin.item.data.price,
        changePercent: 0,
        isProfit: true
      };
      
      const price = coinData.currentPrice;
      const change24h = coin.price_change_percentage_24h || coin.item?.data.price_change_percentage_24h?.usd || 0;
      const marketCap = coin.market_cap || coin.item?.data.market_cap;
      const volume = coin.total_volume || coin.item?.data.total_volume;
      const high24h = coin.high_24h || coin.item?.data.high_24h?.usd;
      const low24h = coin.low_24h || coin.item?.data.low_24h?.usd;
      
      content.innerHTML = `
        <div class="coin-header">
          <img src="${coin.image || coin.item.small}" alt="${coin.name}" class="coin-icon-lg">
          <div>
            <div class="coin-name">${coin.name}</div>
            <div class="coin-symbol">${coin.symbol?.toUpperCase() || coin.id.toUpperCase()}</div>
          </div>
        </div>
        
        <div class="coin-price">$${price.toFixed(2)}</div>
        <div class="price-change ${coinData.isProfit ? 'positive' : 'negative'}">
          ${coinData.isProfit ? '+' : ''}${coinData.changePercent.toFixed(2)}% (${coinData.isProfit ? 'Profit' : 'Loss'})
        </div>
        
        <div class="coin-stats">
          <div class="stat-item">
            <div class="stat-label">Market Cap</div>
            <div class="stat-value">$${(marketCap / 1000000000).toFixed(2)}B</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">24h Volume</div>
            <div class="stat-value">$${(volume / 1000000).toFixed(2)}M</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">24h High</div>
            <div class="stat-value">$${high24h?.toFixed(2) || 'N/A'}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">24h Low</div>
            <div class="stat-value">$${low24h?.toFixed(2) || 'N/A'}</div>
          </div>
        </div>
        
        <div class="coin-chart">
          <iframe src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_coin_detail&symbol=BINANCE:${coin.symbol?.toUpperCase() || coin.id.toUpperCase()}USDT&interval=D&hidesidetoolbar=1&theme=dark"></iframe>
        </div>
        
        <div class="trade-buttons">
          <button class="btn btn-primary" onclick="showTradeForm('${coin.id || coin.item.id}', 'buy')">Buy</button>
          <button class="btn btn-outline" onclick="showTradeForm('${coin.id || coin.item.id}', 'sell')">Sell</button>
        </div>
      `;
      
      modal.style.display = 'flex';
    }
    
    function showTradeForm(coinId, action) {
      if (!currentUser) {
        document.getElementById('loginPrompt').style.display = 'flex';
        return;
      }
      
      const coin = [...allCoinsData, ...allGainersData, ...allTrendingData.map(c => c.item)]
        .find(c => c.id === coinId);
      
      if (!coin) return;
      
      const coinPrice = coinPrices[coinId]?.currentPrice || 
        (coin.current_price || coin.item?.data.price);
      
      const modal = document.getElementById('tradeModal');
      const title = document.getElementById('tradeModalTitle');
      const content = document.getElementById('tradeModalContent');
      
      title.textContent = `${action === 'buy' ? 'Buy' : 'Sell'} ${coin.name}`;
      
      content.innerHTML = `
        <div class="form-group">
          <label class="form-label">Amount (USD)</label>
          <input type="number" id="tradeAmount" class="form-input" placeholder="Enter amount in USD" min="0.01" step="0.01">
        </div>
        
        <div class="form-group">
          <label class="form-label">Current Price</label>
          <input type="text" class="form-input" value="1 ${coin.symbol?.toUpperCase() || coin.id.toUpperCase()} = $${coinPrice.toFixed(2)}" readonly>
        </div>
        
        <button class="btn ${action === 'buy' ? 'btn-primary' : 'btn-outline'}" 
          onclick="executeTrade('${coinId}', '${action}')">
          ${action === 'buy' ? 'Buy' : 'Sell'} ${coin.name}
        </button>
        
        <div id="tradeResult" style="margin-top: 16px; display: none; padding: 12px; border-radius: 4px; background-color: var(--card-bg);">
          <p id="tradeResultText"></p>
        </div>
      `;
      
      modal.style.display = 'flex';
    }
    
    async function executeTrade(coinId, action) {
      const amountInput = document.getElementById('tradeAmount');
      const amount = parseFloat(amountInput.value);
      
      if (isNaN(amount) {
        showTradeResult('Please enter a valid amount', false);
        return;
      }
      
      const coin = [...allCoinsData, ...allGainersData, ...allTrendingData.map(c => c.item)]
        .find(c => c.id === coinId);
      
      if (!coin) {
        showTradeResult('Coin not found', false);
        return;
      }
      
      const coinPrice = coinPrices[coinId]?.currentPrice || 
        (coin.current_price || coin.item?.data.price);
      
      try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/trades/${action}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            coinId,
            amount,
            price: coinPrice
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          userBalance = result.newBalance;
          userPortfolio = result.portfolio || [];
          
          document.getElementById('profitAmount').textContent = result.profit.toFixed(2);
          document.getElementById('successText').textContent = 
            result.profit > 0 ? 
              `You made a profit of $${result.profit.toFixed(2)}!` : 
              'Trade executed successfully!';
              
          closeModal('tradeModal');
          document.getElementById('successMessage').style.display = 'flex';
          
          updateUserDisplay();
          updatePortfolioChange();
        } else {
          const error = await response.json();
          showTradeResult(error.message || 'Trade failed', false);
        }
      } catch (error) {
        console.error('Trade error:', error);
        showTradeResult('Network error. Please try again.', false);
      }
    }
    
    function showTradeResult(message, isSuccess) {
      const resultDiv = document.getElementById('tradeResult');
      const resultText = document.getElementById('tradeResultText');
      
      resultText.textContent = message;
      resultDiv.style.display = 'block';
      resultDiv.style.backgroundColor = isSuccess ? 'rgba(14, 203, 129, 0.1)' : 'rgba(246, 70, 93, 0.1)';
      resultDiv.style.borderLeft = `4px solid ${isSuccess ? 'var(--positive)' : 'var(--negative)'}`;
    }
    
    function showPortfolio() {
      if (!currentUser) {
        document.getElementById('loginPrompt').style.display = 'flex';
        return;
      }
      
      const modal = document.getElementById('portfolioModal');
      const tbody = document.getElementById('portfolioTableBody');
      
      tbody.innerHTML = '';
      
      if (!userPortfolio.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 40px;">
              Your portfolio is empty
            </td>
          </tr>
        `;
        modal.style.display = 'flex';
        return;
      }
      
      userPortfolio.forEach(item => {
        const coin = [...allCoinsData, ...allGainersData, ...allTrendingData.map(c => c.item)]
          .find(c => c.id === item.coinId) || {
            name: item.coinId,
            symbol: item.coinId.toUpperCase(),
            image: 'https://via.placeholder.com/24',
            price_change_percentage_24h_in_currency: 0
          };
          
        const coinData = coinPrices[item.coinId] || {
          currentPrice: item.currentPrice || 0,
          changePercent: 0,
          isProfit: true
        };
        
        const value = item.amount * coinData.currentPrice;
        const change24h = coin.price_change_percentage_24h_in_currency || 0;
        const changeClass = change24h >= 0 ? 'positive' : 'negative';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div class="coin-cell">
              <img src="${coin.image}" alt="${coin.name}" class="coin-icon">
              <span>${coin.name}</span>
            </div>
          </td>
          <td>${item.amount.toFixed(8)}</td>
          <td>$${value.toFixed(2)}</td>
          <td class="${changeClass}">${change24h.toFixed(2)}%</td>
          <td>
            <button class="btn btn-outline" style="padding: 4px 8px; font-size: 12px;" 
              onclick="event.stopPropagation(); showTradeForm('${item.coinId}', 'buy')">
              Buy
            </button>
            <button class="btn btn-outline" style="padding: 4px 8px; font-size: 12px; margin-left: 4px;" 
              onclick="event.stopPropagation(); showTradeForm('${item.coinId}', 'sell')">
              Sell
            </button>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
      
      modal.style.display = 'flex';
    }
    
    // View More Functions
    function showMoreCoins() {
      const modal = document.getElementById('moreCoinsModal');
      const tbody = document.querySelector('#allCoinsTable tbody');
      
      tbody.innerHTML = '';
      
      allCoinsData.slice(10).forEach(coin => {
        const coinData = coinPrices[coin.id] || {
          currentPrice: coin.current_price,
          changePercent: 0,
          isProfit: true
        };
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div class="coin-cell">
              <img src="${coin.image}" alt="${coin.name}" class="coin-icon">
              <span>${coin.name}</span>
            </div>
          </td>
          <td>$${coinData.currentPrice.toFixed(2)}</td>
          <td class="${coin.price_change_percentage_24h >= 0 ? 'positive' : 'negative'}">
            ${coin.price_change_percentage_24h?.toFixed(2) || '0.00'}%
          </td>
          <td>$${(coin.total_volume / 1000000).toFixed(2)}M</td>
          <td>$${(coin.market_cap / 1000000000).toFixed(2)}B</td>
          <td>
            <button class="btn btn-outline" style="padding: 4px 8px; font-size: 12px;" 
              onclick="event.stopPropagation(); showTradeForm('${coin.id}', 'buy')">
              Buy
            </button>
          </td>
        `;
        
        tr.addEventListener('click', () => {
          closeModal('moreCoinsModal');
          showCoinDetail(coin);
        });
        
        tbody.appendChild(tr);
      });
      
      modal.style.display = 'flex';
    }
    
    function showMoreGainers() {
      const modal = document.getElementById('moreGainersModal');
      const list = document.getElementById('allGainersList');
      
      list.innerHTML = '';
      
      allGainersData.slice(5).forEach(coin => {
        const coinData = coinPrices[coin.id] || {
          currentPrice: coin.current_price,
          changePercent: 0,
          isProfit: true
        };
        
        const li = document.createElement('li');
        li.className = 'coin-item';
        li.innerHTML = `
          <div class="coin-info">
            <img src="${coin.image}" alt="${coin.name}" width="20">
            <span>${coin.name}</span>
          </div>
          <div class="price-change ${coin.price_change_percentage_24h >= 0 ? 'positive' : 'negative'}">
            $${coinData.currentPrice.toFixed(2)} <span>${coin.price_change_percentage_24h?.toFixed(2) || '0.00'}%</span>
          </div>
        `;
        
        li.addEventListener('click', () => {
          closeModal('moreGainersModal');
          showCoinDetail(coin);
        });
        
        list.appendChild(li);
      });
      
      modal.style.display = 'flex';
    }
    
    function showMoreTrending() {
      const modal = document.getElementById('moreTrendingModal');
      const list = document.getElementById('allTrendingList');
      
      list.innerHTML = '';
      
      allTrendingData.slice(5).forEach(coin => {
        const coinData = coinPrices[coin.item.id] || {
          currentPrice: coin.item.data.price,
          changePercent: 0,
          isProfit: true
        };
        
        const li = document.createElement('li');
        li.className = 'coin-item';
        li.innerHTML = `
          <div class="coin-info">
            <img src="${coin.item.small}" alt="${coin.item.name}" width="20">
            <span>${coin.item.name}</span>
          </div>
          <div class="price-change ${coin.item.data.price_change_percentage_24h.usd >= 0 ? 'positive' : 'negative'}">
            $${coinData.currentPrice.toFixed(2)} <span>${coin.item.data.price_change_percentage_24h.usd?.toFixed(2) || '0.00'}%</span>
          </div>
        `;
        
        li.addEventListener('click', () => {
          closeModal('moreTrendingModal');
          showCoinDetail(coin);
        });
        
        list.appendChild(li);
      });
      
      modal.style.display = 'flex';
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    // Withdrawal Feed
    function startWithdrawalCycle() {
      updateWithdrawalFeed();
      setInterval(updateWithdrawalFeed, 3000);
    }
    
    function updateWithdrawalFeed() {
      const coins = ['BTC', 'ETH', 'USDT', 'XRP', 'ADA', 'SOL', 'DOGE'];
      const coin = coins[Math.floor(Math.random() * coins.length)];
      
      let amount;
      if (coin === 'BTC') {
        amount = (0.00422 + Math.random() * 10.23).toFixed(6);
      } else if (coin === 'ETH') {
        amount = (0.01 + Math.random() * 15).toFixed(4);
      } else if (coin === 'USDT') {
        amount = (100 + Math.random() * 10000).toFixed(2);
      } else {
        amount = (10 + Math.random() * 1000).toFixed(2);
      }
      
      const wallet = generateRandomWallet();
      const withdrawalText = `user ${wallet} withdrawn ${amount} ${coin}`;
      
      if (!withdrawalMessages.includes(withdrawalText)) {
        withdrawalMessages.push(withdrawalText);
        if (withdrawalMessages.length > 10) {
          withdrawalMessages.shift();
        }
        
        document.getElementById('withdrawals').innerHTML = withdrawalMessages
          .map(msg => `<div class="withdrawal-item">${msg}</div>`)
          .join('');
      }
    }
    
    function generateRandomWallet() {
      const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
      let wallet = '';
      
      for (let i = 0; i < 6; i++) {
        wallet += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      
      wallet += '**************************';
      
      for (let i = 0; i < 6; i++) {
        wallet += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      
      return wallet;
    }
    
    // Stats Increment
    function startStatsIncrement() {
      setInterval(incrementStats, 2000);
    }
    
    function incrementStats() {
      const tradersElement = document.getElementById('traders');
      let traders = parseInt(tradersElement.textContent.replace(/,/g, '')) || 8021905;
      traders += Math.floor(Math.random() * 5) + 1;
      tradersElement.textContent = traders.toLocaleString();
      
      const volumeElement = document.getElementById('volume');
      let volume = parseFloat(volumeElement.textContent.replace(/[$,]/g, '')) || 1129813145.20;
      volume += (Math.random() * 4000 + 1000).toFixed(2);
      volumeElement.textContent = `$${volume.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }
    
    // Notification
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }
    
    // Broadcast Message Styles
    const broadcastStyle = document.createElement('style');
    broadcastStyle.textContent = `
      .broadcast-message {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background-color: var(--card-bg);
        padding: 12px 20px;
        border-bottom: 1px solid var(--border-color);
        z-index: 1000;
        animation: slideDown 0.3s ease-out;
      }
      
      .broadcast-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      
      .broadcast-header button {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 20px;
        cursor: pointer;
      }
      
      .broadcast-content {
        font-size: 14px;
      }
      
      @keyframes slideDown {
        from { transform: translateY(-100%); }
        to { transform: translateY(0); }
      }
    `;
    document.head.appendChild(broadcastStyle);
  </script>
</body>
</html>
