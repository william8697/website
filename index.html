<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Professional Crypto Trading Platform with real-time market data">
  <meta name="keywords" content="crypto, trading, bitcoin, ethereum, cryptocurrency">
  <title>Crypto Trading Platform</title>
  <style>
    :root {
      --primary-bg: #0b0e11;
      --secondary-bg: #1e2329;
      --tertiary-bg: #2b3139;
      --primary-text: #eaecef;
      --secondary-text: #848e9c;
      --accent-yellow: #f0b90b;
      --accent-green: #02c076;
      --accent-red: #f6465d;
      --border-color: #2b3139;
      --nav-height: 64px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    
    body {
      background-color: var(--primary-bg);
      color: var(--primary-text);
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Header Styles */
    header {
      background-color: var(--secondary-bg);
      height: var(--nav-height);
      display: flex;
      align-items: center;
      padding: 0 20px;
      border-bottom: 1px solid var(--border-color);
      position: fixed;
      width: 100%;
      z-index: 100;
    }
    
    .logo {
      display: flex;
      align-items: center;
      margin-right: 40px;
    }
    
    .logo img {
      height: 24px;
      margin-right: 8px;
    }
    
    .logo h1 {
      font-size: 18px;
      font-weight: 600;
    }
    
    nav {
      display: flex;
      flex-grow: 1;
    }
    
    .nav-links {
      display: flex;
      list-style: none;
    }
    
    .nav-links li {
      margin-right: 24px;
    }
    
    .nav-links a {
      color: var(--secondary-text);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: color 0.2s;
      display: flex;
      align-items: center;
      height: var(--nav-height);
    }
    
    .nav-links a:hover {
      color: var(--primary-text);
    }
    
    .nav-links a.active {
      color: var(--primary-text);
      border-bottom: 3px solid var(--accent-yellow);
    }
    
    .auth-buttons {
      display: flex;
      align-items: center;
    }
    
    .login-btn, .signup-btn {
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .login-btn {
      background: transparent;
      color: var(--primary-text);
      border: 1px solid var(--border-color);
      margin-right: 12px;
    }
    
    .login-btn:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .signup-btn {
      background: var(--accent-yellow);
      color: #000;
      border: none;
    }
    
    .signup-btn:hover {
      background: #f8d12f;
    }
    
    .user-menu {
      display: flex;
      align-items: center;
      position: relative;
    }
    
    .user-balance {
      background: var(--tertiary-bg);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      margin-right: 16px;
      cursor: pointer;
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: var(--accent-yellow);
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
    }
    
    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--secondary-bg);
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      width: 200px;
      overflow: hidden;
      display: none;
      z-index: 10;
    }
    
    .dropdown-menu a {
      display: block;
      padding: 12px 16px;
      color: var(--primary-text);
      text-decoration: none;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    .dropdown-menu a:hover {
      background: var(--tertiary-bg);
    }
    
    .dropdown-menu.show {
      display: block;
    }
    
    /* Main Content */
    main {
      padding-top: var(--nav-height);
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .container {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 20px;
      padding: 20px;
    }
    
    /* Market Data Table */
    .market-table {
      background: var(--secondary-bg);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .table-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .table-header h2 {
      font-size: 16px;
      font-weight: 600;
    }
    
    .view-all {
      color: var(--accent-yellow);
      font-size: 14px;
      cursor: pointer;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px 16px;
      text-align: left;
      font-size: 14px;
    }
    
    th {
      color: var(--secondary-text);
      font-weight: 500;
    }
    
    tr {
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
    }
    
    tr:last-child {
      border-bottom: none;
    }
    
    tr:hover {
      background: var(--tertiary-bg);
    }
    
    .coin-cell {
      display: flex;
      align-items: center;
    }
    
    .coin-cell img {
      width: 24px;
      height: 24px;
      margin-right: 8px;
    }
    
    .coin-name {
      font-weight: 500;
    }
    
    .coin-symbol {
      color: var(--secondary-text);
      margin-left: 4px;
    }
    
    .positive {
      color: var(--accent-green);
    }
    
    .negative {
      color: var(--accent-red);
    }
    
    .trade-buttons {
      display: flex;
      gap: 8px;
    }
    
    .buy-btn, .sell-btn {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }
    
    .buy-btn {
      background: var(--accent-green);
      color: #000;
    }
    
    .sell-btn {
      background: var(--accent-red);
      color: #000;
    }
    
    /* Sidebar */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .widget {
      background: var(--secondary-bg);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .widget-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      font-size: 16px;
      font-weight: 600;
    }
    
    .widget-content {
      padding: 16px;
    }
    
    .coin-list {
      list-style: none;
    }
    
    .coin-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
    }
    
    .coin-item:last-child {
      border-bottom: none;
    }
    
    .coin-info {
      display: flex;
      align-items: center;
    }
    
    .coin-info img {
      width: 20px;
      height: 20px;
      margin-right: 8px;
    }
    
    .price-change {
      font-weight: 500;
    }
    
    /* Stats Widget */
    .stats-widget {
      display: flex;
      justify-content: space-between;
      background: linear-gradient(135deg, #1e2329, #2b3139);
      padding: 16px;
      border-radius: 8px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-label {
      color: var(--secondary-text);
      font-size: 12px;
      margin-bottom: 4px;
    }
    
    .stat-value {
      font-size: 16px;
      font-weight: 600;
    }
    
    /* Withdrawals Feed */
    .withdrawals-feed {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      background: var(--secondary-bg);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      overflow: hidden;
      z-index: 50;
    }
    
    .feed-header {
      padding: 12px 16px;
      background: var(--tertiary-bg);
      font-size: 14px;
      font-weight: 500;
    }
    
    .feed-content {
      max-height: 200px;
      overflow-y: auto;
    }
    
    .withdrawal-item {
      padding: 12px 16px;
      font-size: 13px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .withdrawal-item:last-child {
      border-bottom: none;
    }
    
    /* Modals */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    
    .modal.show {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background: var(--secondary-bg);
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    
    .modal-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .close-modal {
      background: none;
      border: none;
      color: var(--secondary-text);
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
    }
    
    .modal-body {
      padding: 16px;
    }
    
    /* Coin Detail Modal */
    .coin-detail-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .coin-detail-header img {
      width: 40px;
      height: 40px;
      margin-right: 12px;
    }
    
    .coin-name-large {
      font-size: 24px;
      font-weight: 600;
    }
    
    .coin-symbol-large {
      color: var(--secondary-text);
      font-size: 16px;
      margin-left: 8px;
    }
    
    .coin-price-large {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .price-change-large {
      font-size: 18px;
      margin-bottom: 24px;
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .coin-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: var(--tertiary-bg);
      padding: 16px;
      border-radius: 4px;
    }
    
    .stat-label {
      color: var(--secondary-text);
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .stat-value-large {
      font-size: 18px;
      font-weight: 600;
    }
    
    .coin-chart {
      height: 400px;
      background: var(--tertiary-bg);
      border-radius: 4px;
      margin-bottom: 24px;
    }
    
    /* Trade Form */
    .trade-form {
      margin-top: 24px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      background: var(--tertiary-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--primary-text);
      font-size: 14px;
    }
    
    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .form-actions button {
      flex: 1;
      padding: 12px;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    
    /* Portfolio Modal */
    .portfolio-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    /* Alerts */
    .alert {
      padding: 16px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
    }
    
    .alert-info {
      background: rgba(2, 192, 118, 0.1);
      border-left: 4px solid var(--accent-green);
    }
    
    .alert-warning {
      background: rgba(240, 185, 11, 0.1);
      border-left: 4px solid var(--accent-yellow);
    }
    
    .alert-icon {
      margin-right: 12px;
      font-size: 20px;
    }
    
    .alert-content {
      flex: 1;
    }
    
    .alert-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        grid-row: 1;
      }
    }
    
    @media (max-width: 768px) {
      .nav-links {
        display: none;
      }
      
      .container {
        padding: 10px;
      }
      
      th, td {
        padding: 8px 12px;
      }
      
      .withdrawals-feed {
        width: 250px;
        right: 10px;
      }
    }
    
    @media (max-width: 480px) {
      .auth-buttons {
        display: none;
      }
      
      .user-balance {
        margin-right: 8px;
        padding: 4px 8px;
      }
      
      .withdrawals-feed {
        width: 200px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="https://cryptologos.cc/logos/binance-coin-bnb-logo.png" alt="Logo">
      <h1>Crypto Trade</h1>
    </div>
    
    <nav>
      <ul class="nav-links">
        <li><a href="#" class="active">Markets</a></li>
        <li><a href="#">Trade</a></li>
        <li><a href="#">Futures</a></li>
        <li><a href="#">Earn</a></li>
        <li><a href="#">Derivatives</a></li>
      </ul>
    </nav>
    
    <div class="auth-buttons" id="authButtons">
      <button class="login-btn" id="loginBtn">Log In</button>
      <button class="signup-btn" id="signupBtn">Sign Up</button>
    </div>
    
    <div class="user-menu" id="userMenu" style="display: none;">
      <div class="user-balance" id="userBalance">$0.00</div>
      <div class="user-avatar" id="userAvatar">U</div>
      <div class="dropdown-menu" id="dropdownMenu">
        <a href="#" id="portfolioLink">Portfolio</a>
        <a href="#" id="ordersLink">Orders</a>
        <a href="#" id="settingsLink">Settings</a>
        <a href="#" id="logoutLink">Logout</a>
      </div>
    </div>
  </header>
  
  <main>
    <div class="container">
      <div class="market-section">
        <div class="alert alert-info" id="welcomeAlert" style="display: none;">
          <span class="alert-icon">üëã</span>
          <div class="alert-content">
            <div class="alert-title">Welcome back, <span id="welcomeUsername"></span>!</div>
            <div>Your portfolio is up <span id="portfolioChange" class="positive">0%</span> today.</div>
          </div>
        </div>
        
        <div class="alert alert-warning" id="loginAlert">
          <span class="alert-icon">‚ö†Ô∏è</span>
          <div class="alert-content">
            <div class="alert-title">Notice</div>
            <div>You're currently viewing as a guest. <a href="#" id="loginLink" style="color: var(--accent-yellow);">Login</a> or <a href="#" id="signupLink" style="color: var(--accent-yellow);">Sign Up</a> to start trading.</div>
          </div>
        </div>
        
        <div class="market-table">
          <div class="table-header">
            <h2>Market</h2>
            <span class="view-all" id="viewAllCoins">View All</span>
          </div>
          
          <table id="marketTable">
            <thead>
              <tr>
                <th>Coin</th>
                <th>Price</th>
                <th>24h Change</th>
                <th>Volume</th>
                <th>Market Cap</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="marketTableBody">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px;">
                  Loading market data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="sidebar">
        <div class="stats-widget">
          <div class="stat-item">
            <div class="stat-label">Traders</div>
            <div class="stat-value" id="tradersCount">8,021,905</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Volume</div>
            <div class="stat-value" id="totalVolume">$1.12B</div>
          </div>
        </div>
        
        <div class="widget">
          <div class="widget-header">Top Gainers</div>
          <div class="widget-content">
            <ul class="coin-list" id="topGainers">
              <li class="coin-item">
                <div>Loading...</div>
              </li>
            </ul>
          </div>
        </div>
        
        <div class="widget">
          <div class="widget-header">Trending</div>
          <div class="widget-content">
            <ul class="coin-list" id="trendingCoins">
              <li class="coin-item">
                <div>Loading...</div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <div class="withdrawals-feed">
    <div class="feed-header">Recent Withdrawals</div>
    <div class="feed-content" id="withdrawalsFeed">
      <div class="withdrawal-item">Loading withdrawals...</div>
    </div>
  </div>
  
  <!-- Coin Detail Modal -->
  <div class="modal" id="coinDetailModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Coin Details</div>
        <button class="close-modal" id="closeCoinModal">&times;</button>
      </div>
      <div class="modal-body" id="coinDetailContent">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>
  </div>
  
  <!-- All Coins Modal -->
  <div class="modal" id="allCoinsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">All Cryptocurrencies</div>
        <button class="close-modal" id="closeAllCoinsModal">&times;</button>
      </div>
      <div class="modal-body">
        <table id="allCoinsTable">
          <thead>
            <tr>
              <th>Coin</th>
              <th>Price</th>
              <th>24h Change</th>
              <th>Volume</th>
              <th>Market Cap</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="allCoinsTableBody">
            <!-- Content will be loaded dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Trade Modal -->
  <div class="modal" id="tradeModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="tradeModalTitle">Trade</div>
        <button class="close-modal" id="closeTradeModal">&times;</button>
      </div>
      <div class="modal-body" id="tradeModalContent">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>
  </div>
  
  <!-- Portfolio Modal -->
  <div class="modal" id="portfolioModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Your Portfolio</div>
        <button class="close-modal" id="closePortfolioModal">&times;</button>
      </div>
      <div class="modal-body">
        <table class="portfolio-table">
          <thead>
            <tr>
              <th>Coin</th>
              <th>Amount</th>
              <th>Value</th>
              <th>24h Change</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="portfolioTableBody">
            <tr>
              <td colspan="5" style="text-align: center; padding: 40px;">
                Loading portfolio...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Login Modal -->
  <div class="modal" id="loginModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Login</div>
        <button class="close-modal" id="closeLoginModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="loginForm">
          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" required>
          </div>
          <div class="form-group">
            <label for="loginPassword">Password</label>
            <input type="password" id="loginPassword" required>
          </div>
          <div class="form-actions">
            <button type="submit" class="signup-btn">Login</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Signup Modal -->
  <div class="modal" id="signupModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Create Account</div>
        <button class="close-modal" id="closeSignupModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="signupForm">
          <div class="form-group">
            <label for="signupEmail">Email</label>
            <input type="email" id="signupEmail" required>
          </div>
          <div class="form-group">
            <label for="signupPassword">Password</label>
            <input type="password" id="signupPassword" required>
          </div>
          <div class="form-group">
            <label for="signupFirstName">First Name</label>
            <input type="text" id="signupFirstName" required>
          </div>
          <div class="form-actions">
            <button type="submit" class="signup-btn">Sign Up</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Success Modal -->
  <div class="modal" id="successModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Success</div>
        <button class="close-modal" id="closeSuccessModal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="successMessage">Operation completed successfully!</div>
        <div class="form-actions">
          <button class="signup-btn" id="confirmSuccess">OK</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // API Configuration
    const API_BASE_URL = 'https://website-backendd-1.onrender.com/api/v1';
    let currentUser = null;
    let userBalance = 0;
    let userPortfolio = [];
    let marketData = [];
    let coinPrices = {};
    let socket = null;
    
    // DOM Elements
    const authButtons = document.getElementById('authButtons');
    const userMenu = document.getElementById('userMenu');
    const userBalanceEl = document.getElementById('userBalance');
    const userAvatar = document.getElementById('userAvatar');
    const dropdownMenu = document.getElementById('dropdownMenu');
    const welcomeAlert = document.getElementById('welcomeAlert');
    const loginAlert = document.getElementById('loginAlert');
    const welcomeUsername = document.getElementById('welcomeUsername');
    const portfolioChange = document.getElementById('portfolioChange');
    const marketTableBody = document.getElementById('marketTableBody');
    const topGainers = document.getElementById('topGainers');
    const trendingCoins = document.getElementById('trendingCoins');
    const withdrawalsFeed = document.getElementById('withdrawalsFeed');
    const tradersCount = document.getElementById('tradersCount');
    const totalVolume = document.getElementById('totalVolume');
    const portfolioTableBody = document.getElementById('portfolioTableBody');
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      checkAuthStatus();
      loadMarketData();
      startWithdrawalFeed();
      setupEventListeners();
    });
    
    // Check authentication status
    async function checkAuthStatus() {
      try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (!token) {
          updateUIForGuest();
          return;
        }
        
        const response = await fetch(`${API_BASE_URL}/auth/status`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          currentUser = data.user;
          userBalance = data.balance || 0;
          userPortfolio = data.portfolio || [];
          updateUIForUser();
          connectWebSocket(token);
        } else {
          clearAuthData();
          updateUIForGuest();
        }
      } catch (error) {
        console.error('Error checking auth status:', error);
        clearAuthData();
        updateUIForGuest();
      }
    }
    
    // Connect to WebSocket
    function connectWebSocket(token) {
      if (socket) {
        socket.close();
      }
      
      socket = new WebSocket('wss://website-backendd-1.onrender.com');
      
      socket.addEventListener('open', () => {
        console.log('WebSocket connected');
        socket.send(JSON.stringify({
          type: 'AUTHENTICATE',
          token: token
        }));
      });
      
      socket.addEventListener('message', (event) => {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
      });
      
      socket.addEventListener('close', () => {
        console.log('WebSocket disconnected');
        setTimeout(() => connectWebSocket(token), 5000);
      });
      
      socket.addEventListener('error', (error) => {
        console.error('WebSocket error:', error);
      });
    }
    
    // Handle WebSocket messages
    function handleWebSocketMessage(data) {
      switch (data.type) {
        case 'BALANCE_UPDATE':
          userBalance = data.balance;
          updateUserBalance();
          break;
        case 'TRADE_UPDATE':
          showTradeNotification(data);
          break;
        case 'PORTFOLIO_UPDATE':
          userPortfolio = data.portfolio || [];
          updatePortfolioChange();
          break;
        case 'ADMIN_MESSAGE':
          showAdminMessage(data.message);
          break;
        case 'BALANCE_ADDED':
          showBalanceAddedNotification(data.amount);
          break;
      }
    }
    
    // Update UI for logged in user
    function updateUIForUser() {
      authButtons.style.display = 'none';
      userMenu.style.display = 'flex';
      welcomeAlert.style.display = 'flex';
      loginAlert.style.display = 'none';
      
      updateUserBalance();
      updateUserAvatar();
      updatePortfolioChange();
      
      welcomeUsername.textContent = currentUser.firstName || currentUser.email.split('@')[0];
    }
    
    // Update UI for guest
    function updateUIForGuest() {
      authButtons.style.display = 'flex';
      userMenu.style.display = 'none';
      welcomeAlert.style.display = 'none';
      loginAlert.style.display = 'flex';
    }
    
    // Update user balance display
    function updateUserBalance() {
      userBalanceEl.textContent = `$${userBalance.toFixed(2)}`;
    }
    
    // Update user avatar
    function updateUserAvatar() {
      userAvatar.textContent = currentUser.firstName ? currentUser.firstName.charAt(0).toUpperCase() : currentUser.email.charAt(0).toUpperCase();
    }
    
    // Update portfolio change
    function updatePortfolioChange() {
      const change = calculatePortfolioChange();
      portfolioChange.textContent = `${change.toFixed(2)}%`;
      portfolioChange.className = change >= 0 ? 'positive' : 'negative';
    }
    
    // Calculate portfolio change
    function calculatePortfolioChange() {
      if (!userPortfolio || userPortfolio.length === 0) return 0;
      
      let totalValue = 0;
      let totalChange = 0;
      
      userPortfolio.forEach(item => {
        const coin = marketData.find(c => c.id === item.coinId);
        if (coin) {
          const currentPrice = coinPrices[coin.id]?.currentPrice || coin.current_price;
          const change24h = coin.price_change_percentage_24h || 0;
          const value = item.amount * currentPrice;
          
          totalValue += value;
          totalChange += value * (change24h / 100);
        }
      });
      
      return totalValue > 0 ? (totalChange / totalValue) * 100 : 0;
    }
    
    // Clear authentication data
    function clearAuthData() {
      localStorage.removeItem('token');
      sessionStorage.removeItem('token');
      currentUser = null;
      userBalance = 0;
      userPortfolio = [];
      
      if (socket) {
        socket.close();
        socket = null;
      }
    }
    
    // Load market data
    async function loadMarketData() {
      try {
        const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1&sparkline=false&price_change_percentage=24h');
        marketData = await response.json();
        
        // Initialize coin prices
        marketData.forEach(coin => {
          if (!coinPrices[coin.id]) {
            coinPrices[coin.id] = {
              originalPrice: coin.current_price,
              currentPrice: coin.current_price,
              changePercent: 0,
              isProfit: true
            };
          }
        });
        
        updateMarketTable();
        updateTopGainers();
        updateTrendingCoins();
        
        // Start price updates
        setInterval(updatePrices, 30000);
      } catch (error) {
        console.error('Error loading market data:', error);
        // Fallback data if API fails
        marketData = getFallbackMarketData();
        updateMarketTable();
        updateTopGainers();
        updateTrendingCoins();
      }
    }
    
    // Update market table
    function updateMarketTable() {
      marketTableBody.innerHTML = '';
      
      marketData.slice(0, 10).forEach(coin => {
        const coinData = coinPrices[coin.id] || {
          currentPrice: coin.current_price,
          changePercent: 0,
          isProfit: true
        };
        
        const change24h = coin.price_change_percentage_24h || 0;
        const changeClass = change24h >= 0 ? 'positive' : 'negative';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="coin-cell">
            <img src="${coin.image}" alt="${coin.name}">
            <span class="coin-name">${coin.name}</span>
            <span class="coin-symbol">${coin.symbol.toUpperCase()}</span>
          </td>
          <td>$${coinData.currentPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
          <td class="${changeClass}">${change24h.toFixed(2)}%</td>
          <td>$${(coin.total_volume / 1000000).toFixed(2)}M</td>
          <td>$${(coin.market_cap / 1000000000).toFixed(2)}B</td>
          <td class="trade-buttons">
            <button class="buy-btn" data-coin-id="${coin.id}" data-action="buy">Buy</button>
            <button class="sell-btn" data-coin-id="${coin.id}" data-action="sell">Sell</button>
          </td>
        `;
        
        row.addEventListener('click', () => showCoinDetail(coin));
        marketTableBody.appendChild(row);
      });
    }
    
    // Update top gainers
    function updateTopGainers() {
      topGainers.innerHTML = '';
      
      // Sort by 24h change descending
      const sorted = [...marketData].sort((a, b) => 
        (b.price_change_percentage_24h || 0) - (a.price_change_percentage_24h || 0)
      );
      
      sorted.slice(0, 5).forEach(coin => {
        const coinData = coinPrices[coin.id] || {
          currentPrice: coin.current_price,
          changePercent: 0,
          isProfit: true
        };
        
        const change24h = coin.price_change_percentage_24h || 0;
        const changeClass = change24h >= 0 ? 'positive' : 'negative';
        
        const item = document.createElement('li');
        item.className = 'coin-item';
        item.innerHTML = `
          <div class="coin-info">
            <img src="${coin.image}" alt="${coin.name}">
            <span>${coin.name}</span>
          </div>
          <div class="price-change ${changeClass}">
            $${coinData.currentPrice.toFixed(2)} <span>${change24h.toFixed(2)}%</span>
          </div>
        `;
        
        item.addEventListener('click', () => showCoinDetail(coin));
        topGainers.appendChild(item);
      });
    }
    
    // Update trending coins
    function updateTrendingCoins() {
      trendingCoins.innerHTML = '';
      
      // Sort by volume descending
      const sorted = [...marketData].sort((a, b) => b.total_volume - a.total_volume);
      
      sorted.slice(0, 5).forEach(coin => {
        const coinData = coinPrices[coin.id] || {
          currentPrice: coin.current_price,
          changePercent: 0,
          isProfit: true
        };
        
        const change24h = coin.price_change_percentage_24h || 0;
        const changeClass = change24h >= 0 ? 'positive' : 'negative';
        
        const item = document.createElement('li');
        item.className = 'coin-item';
        item.innerHTML = `
          <div class="coin-info">
            <img src="${coin.image}" alt="${coin.name}">
            <span>${coin.name}</span>
          </div>
          <div class="price-change ${changeClass}">
            $${coinData.currentPrice.toFixed(2)} <span>${change24h.toFixed(2)}%</span>
          </div>
        `;
        
        item.addEventListener('click', () => showCoinDetail(coin));
        trendingCoins.appendChild(item);
      });
    }
    
    // Update prices with random variations
    function updatePrices() {
      marketData.forEach(coin => {
        if (!coinPrices[coin.id]) {
          coinPrices[coin.id] = {
            originalPrice: coin.current_price,
            currentPrice: coin.current_price,
            changePercent: 0,
            isProfit: true
          };
        }
        
        // Random price change between -5% and +10%
        const changePercent = (Math.random() * 15 - 5) / 100;
        coinPrices[coin.id].currentPrice = coinPrices[coin.id].originalPrice * (1 + changePercent);
        coinPrices[coin.id].changePercent = changePercent * 100;
        coinPrices[coin.id].isProfit = changePercent >= 0;
      });
      
      updateMarketTable();
      updateTopGainers();
      updateTrendingCoins();
      updatePortfolioChange();
    }
    
    // Show coin detail modal
    function showCoinDetail(coin) {
      const modal = document.getElementById('coinDetailModal');
      const content = document.getElementById('coinDetailContent');
      
      const coinData = coinPrices[coin.id] || {
        currentPrice: coin.current_price,
        changePercent: 0,
        isProfit: true
      };
      
      const change24h = coin.price_change_percentage_24h || 0;
      const changeClass = change24h >= 0 ? 'positive' : 'negative';
      
      content.innerHTML = `
        <div class="coin-detail-header">
          <img src="${coin.image}" alt="${coin.name}">
          <div>
            <div class="coin-name-large">${coin.name} <span class="coin-symbol-large">${coin.symbol.toUpperCase()}</span></div>
          </div>
        </div>
        
        <div class="coin-price-large">$${coinData.currentPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
        <div class="price-change-large ${changeClass}">${change24h >= 0 ? '+' : ''}${change24h.toFixed(2)}%</div>
        
        <div class="coin-stats-grid">
          <div class="stat-card">
            <div class="stat-label">Market Cap</div>
            <div class="stat-value-large">$${(coin.market_cap / 1000000000).toFixed(2)}B</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">24h Volume</div>
            <div class="stat-value-large">$${(coin.total_volume / 1000000).toFixed(2)}M</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">24h High</div>
            <div class="stat-value-large">$${coin.high_24h?.toFixed(2) || 'N/A'}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">24h Low</div>
            <div class="stat-value-large">$${coin.low_24h?.toFixed(2) || 'N/A'}</div>
          </div>
        </div>
        
        <div class="coin-chart">
          <iframe src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_coin_detail&symbol=BINANCE:${coin.symbol.toUpperCase()}USDT&interval=D&hidesidetoolbar=1&theme=dark"></iframe>
        </div>
        
        <div class="trade-form">
          <div class="form-group">
            <label>Amount (USD)</label>
            <input type="number" id="tradeAmount" placeholder="Enter amount in USD" min="0.01" step="0.01">
          </div>
          
          <div class="form-actions">
            <button class="buy-btn" data-coin-id="${coin.id}" data-action="buy">Buy</button>
            <button class="sell-btn" data-coin-id="${coin.id}" data-action="sell">Sell</button>
          </div>
        </div>
      `;
      
      // Add event listeners to the new buttons
      document.querySelector('.buy-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        executeTrade(coin.id, 'buy');
      });
      
      document.querySelector('.sell-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        executeTrade(coin.id, 'sell');
      });
      
      showModal('coinDetailModal');
    }
    
    // Show all coins modal
    function showAllCoinsModal() {
      const modal = document.getElementById('allCoinsModal');
      const tableBody = document.getElementById('allCoinsTableBody');
      
      tableBody.innerHTML = '';
      
      marketData.forEach(coin => {
        const coinData = coinPrices[coin.id] || {
          currentPrice: coin.current_price,
          changePercent: 0,
          isProfit: true
        };
        
        const change24h = coin.price_change_percentage_24h || 0;
        const changeClass = change24h >= 0 ? 'positive' : 'negative';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="coin-cell">
            <img src="${coin.image}" alt="${coin.name}">
            <span class="coin-name">${coin.name}</span>
            <span class="coin-symbol">${coin.symbol.toUpperCase()}</span>
          </td>
          <td>$${coinData.currentPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
          <td class="${changeClass}">${change24h.toFixed(2)}%</td>
          <td>$${(coin.total_volume / 1000000).toFixed(2)}M</td>
          <td>$${(coin.market_cap / 1000000000).toFixed(2)}B</td>
          <td class="trade-buttons">
            <button class="buy-btn" data-coin-id="${coin.id}" data-action="buy">Buy</button>
            <button class="sell-btn" data-coin-id="${coin.id}" data-action="sell">Sell</button>
          </td>
        `;
        
        row.addEventListener('click', () => {
          closeModal('allCoinsModal');
          showCoinDetail(coin);
        });
        
        tableBody.appendChild(row);
      });
      
      showModal('allCoinsModal');
    }
    
    // Show trade form
    function showTradeForm(coinId, action) {
      if (!currentUser) {
        showModal('loginModal');
        return;
      }
      
      const coin = marketData.find(c => c.id === coinId);
      if (!coin) return;
      
      const modal = document.getElementById('tradeModal');
      const title = document.getElementById('tradeModalTitle');
      const content = document.getElementById('tradeModalContent');
      
      title.textContent = `${action === 'buy' ? 'Buy' : 'Sell'} ${coin.name}`;
      
      content.innerHTML = `
        <div class="coin-info" style="margin-bottom: 20px;">
          <img src="${coin.image}" alt="${coin.name}" style="width: 32px; height: 32px; margin-right: 8px;">
          <span style="font-size: 18px; font-weight: 500;">${coin.name} (${coin.symbol.toUpperCase()})</span>
        </div>
        
        <div style="margin-bottom: 16px;">
          <div style="font-size: 14px; color: var(--secondary-text); margin-bottom: 4px;">Current Price</div>
          <div style="font-size: 24px; font-weight: 600;">$${coinPrices[coin.id]?.currentPrice.toFixed(2) || coin.current_price.toFixed(2)}</div>
        </div>
        
        <form id="tradeForm">
          <div class="form-group">
            <label for="tradeAmount">Amount (USD)</label>
            <input type="number" id="tradeAmount" placeholder="Enter amount in USD" min="0.01" step="0.01" required>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="${action === 'buy' ? 'buy-btn' : 'sell-btn'}" style="width: 100%;">
              ${action === 'buy' ? 'Buy' : 'Sell'} ${coin.symbol.toUpperCase()}
            </button>
          </div>
        </form>
        
        <div id="tradeResult" style="margin-top: 16px; display: none;"></div>
      `;
      
      const form = document.getElementById('tradeForm');
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        executeTrade(coinId, action);
      });
      
      showModal('tradeModal');
    }
    
    // Execute trade
    async function executeTrade(coinId, action) {
      const amountInput = document.getElementById('tradeAmount');
      const amount = parseFloat(amountInput.value);
      
      if (isNaN(amount) {
        showError('Please enter a valid amount');
        return;
      }
      
      const coin = marketData.find(c => c.id === coinId);
      if (!coin) return;
      
      const price = coinPrices[coin.id]?.currentPrice || coin.current_price;
      
      try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/trades/${action}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            coinId,
            amount,
            price
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          userBalance = result.newBalance;
          userPortfolio = result.portfolio || [];
          
          updateUserBalance();
          updatePortfolioChange();
          
          showSuccessMessage(`Trade executed successfully! ${result.profit > 0 ? `Profit: $${result.profit.toFixed(2)}` : ''}`);
          closeModal('tradeModal');
        } else {
          const error = await response.json();
          showError(error.message || 'Trade failed');
        }
      } catch (error) {
        console.error('Error executing trade:', error);
        showError('Network error. Please try again.');
      }
    }
    
    // Show portfolio modal
    async function showPortfolioModal() {
      if (!currentUser) {
        showModal('loginModal');
        return;
      }
      
      const modal = document.getElementById('portfolioModal');
      
      try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/portfolio`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          userBalance = data.balance || 0;
          userPortfolio = data.portfolio || [];
          
          updateUserBalance();
          updatePortfolioChange();
          
          portfolioTableBody.innerHTML = '';
          
          if (userPortfolio.length === 0) {
            portfolioTableBody.innerHTML = `
              <tr>
                <td colspan="5" style="text-align: center; padding: 40px;">
                  Your portfolio is empty
                </td>
              </tr>
            `;
          } else {
            userPortfolio.forEach(item => {
              const coin = marketData.find(c => c.id === item.coinId) || {
                name: item.coinId,
                symbol: item.coinId,
                image: 'https://via.placeholder.com/24',
                price_change_percentage_24h: 0
              };
              
              const currentPrice = coinPrices[coin.id]?.currentPrice || coin.current_price || 0;
              const change24h = coin.price_change_percentage_24h || 0;
              const changeClass = change24h >= 0 ? 'positive' : 'negative';
              const value = item.amount * currentPrice;
              
              const row = document.createElement('tr');
              row.innerHTML = `
                <td class="coin-cell">
                  <img src="${coin.image}" alt="${coin.name}">
                  <span class="coin-name">${coin.name}</span>
                  <span class="coin-symbol">${coin.symbol.toUpperCase()}</span>
                </td>
                <td>${item.amount.toFixed(8)}</td>
                <td>$${value.toFixed(2)}</td>
                <td class="${changeClass}">${change24h.toFixed(2)}%</td>
                <td class="trade-buttons">
                  <button class="buy-btn" data-coin-id="${coin.id}" data-action="buy">Buy</button>
                  <button class="sell-btn" data-coin-id="${coin.id}" data-action="sell">Sell</button>
                </td>
              `;
              
              portfolioTableBody.appendChild(row);
            });
          }
          
          showModal('portfolioModal');
        } else {
          showError('Failed to load portfolio');
        }
      } catch (error) {
        console.error('Error loading portfolio:', error);
        showError('Network error loading portfolio');
      }
    }
    
    // Show login modal
    function showLoginModal() {
      showModal('loginModal');
    }
    
    // Show signup modal
    function showSignupModal() {
      showModal('signupModal');
    }
    
    // Handle login
    async function handleLogin(e) {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      try {
        const response = await fetch(`${API_BASE_URL}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email,
            password
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          localStorage.setItem('token', data.token);
          currentUser = data.user;
          userBalance = data.balance || 0;
          userPortfolio = data.portfolio || [];
          
          updateUIForUser();
          closeModal('loginModal');
          showSuccessMessage('Login successful!');
          connectWebSocket(data.token);
        } else {
          const error = await response.json();
          showError(error.message || 'Login failed');
        }
      } catch (error) {
        console.error('Error logging in:', error);
        showError('Network error. Please try again.');
      }
    }
    
    // Handle signup
    async function handleSignup(e) {
      e.preventDefault();
      
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const firstName = document.getElementById('signupFirstName').value;
      
      try {
        const response = await fetch(`${API_BASE_URL}/auth/signup`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email,
            password,
            firstName
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          localStorage.setItem('token', data.token);
          currentUser = data.user;
          userBalance = data.balance || 0;
          userPortfolio = data.portfolio || [];
          
          updateUIForUser();
          closeModal('signupModal');
          showSuccessMessage('Account created successfully!');
          connectWebSocket(data.token);
        } else {
          const error = await response.json();
          showError(error.message || 'Signup failed');
        }
      } catch (error) {
        console.error('Error signing up:', error);
        showError('Network error. Please try again.');
      }
    }
    
    // Handle logout
    function handleLogout() {
      const token = localStorage.getItem('token') || sessionStorage.getItem('token');
      
      if (token) {
        fetch(`${API_BASE_URL}/auth/logout`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        }).catch(error => console.error('Error logging out:', error));
      }
      
      clearAuthData();
      updateUIForGuest();
      showSuccessMessage('Logged out successfully');
    }
    
    // Show modal
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.add('show');
    }
    
    // Close modal
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('show');
    }
    
    // Show success message
    function showSuccessMessage(message) {
      const modal = document.getElementById('successModal');
      const messageEl = document.getElementById('successMessage');
      
      messageEl.textContent = message;
      showModal('successModal');
    }
    
    // Show error message
    function showError(message) {
      const resultEl = document.getElementById('tradeResult');
      if (resultEl) {
        resultEl.style.display = 'block';
        resultEl.innerHTML = `<div style="color: var(--accent-red);">${message}</div>`;
      } else {
        alert(message);
      }
    }
    
    // Start withdrawal feed
    function startWithdrawalFeed() {
      updateWithdrawalFeed();
      setInterval(updateWithdrawalFeed, 3000);
    }
    
    // Update withdrawal feed
    function updateWithdrawalFeed() {
      const coins = ['BTC', 'ETH', 'USDT', 'BNB', 'SOL', 'XRP', 'ADA'];
      const coin = coins[Math.floor(Math.random() * coins.length)];
      
      let amount;
      if (coin === 'BTC') {
        amount = (0.001 + Math.random() * 0.5).toFixed(6);
      } else if (coin === 'ETH') {
        amount = (0.01 + Math.random() * 5).toFixed(4);
      } else if (coin === 'USDT') {
        amount = (50 + Math.random() * 5000).toFixed(2);
      } else {
        amount = (10 + Math.random() * 1000).toFixed(2);
      }
      
      const wallet = generateRandomWallet();
      const message = `User ${wallet} withdrawn ${amount} ${coin}`;
      
      const item = document.createElement('div');
      item.className = 'withdrawal-item';
      item.textContent = message;
      
      withdrawalsFeed.insertBefore(item, withdrawalsFeed.firstChild);
      
      if (withdrawalsFeed.children.length > 10) {
        withdrawalsFeed.removeChild(withdrawalsFeed.lastChild);
      }
    }
    
    // Generate random wallet address
    function generateRandomWallet() {
      const chars = '0123456789ABCDEF';
      let address = '0x';
      
      for (let i = 0; i < 6; i++) {
        address += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      
      address += '...';
      
      for (let i = 0; i < 6; i++) {
        address += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      
      return address;
    }
    
    // Show trade notification
    function showTradeNotification(data) {
      const message = `Trade completed: ${data.profit > 0 ? `Profit $${data.profit.toFixed(2)}` : 'No profit'}. New balance: $${data.balance.toFixed(2)}`;
      
      const notification = document.createElement('div');
      notification.className = 'withdrawal-item';
      notification.textContent = message;
      
      withdrawalsFeed.insertBefore(notification, withdrawalsFeed.firstChild);
      
      if (withdrawalsFeed.children.length > 10) {
        withdrawalsFeed.removeChild(withdrawalsFeed.lastChild);
      }
    }
    
    // Show admin message
    function showAdminMessage(message) {
      const notification = document.createElement('div');
      notification.className = 'withdrawal-item';
      notification.style.color = 'var(--accent-yellow)';
      notification.textContent = `Admin: ${message}`;
      
      withdrawalsFeed.insertBefore(notification, withdrawalsFeed.firstChild);
      
      if (withdrawalsFeed.children.length > 10) {
        withdrawalsFeed.removeChild(withdrawalsFeed.lastChild);
      }
    }
    
    // Show balance added notification
    function showBalanceAddedNotification(amount) {
      const message = `Admin added $${amount.toFixed(2)} to your balance`;
      
      const notification = document.createElement('div');
      notification.className = 'withdrawal-item';
      notification.style.color = 'var(--accent-green)';
      notification.textContent = message;
      
      withdrawalsFeed.insertBefore(notification, withdrawalsFeed.firstChild);
      
      if (withdrawalsFeed.children.length > 10) {
        withdrawalsFeed.removeChild(withdrawalsFeed.lastChild);
      }
    }
    
    // Setup event listeners
    function setupEventListeners() {
      // Auth buttons
      document.getElementById('loginBtn').addEventListener('click', showLoginModal);
      document.getElementById('signupBtn').addEventListener('click', showSignupModal);
      document.getElementById('loginLink').addEventListener('click', showLoginModal);
      document.getElementById('signupLink').addEventListener('click', showSignupModal);
      
      // User menu
      userAvatar.addEventListener('click', () => {
        dropdownMenu.classList.toggle('show');
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!userMenu.contains(e.target)) {
          dropdownMenu.classList.remove('show');
        }
      });
      
      // Portfolio link
      document.getElementById('portfolioLink').addEventListener('click', (e) => {
        e.preventDefault();
        dropdownMenu.classList.remove('show');
        showPortfolioModal();
      });
      
      // Logout link
      document.getElementById('logoutLink').addEventListener('click', (e) => {
        e.preventDefault();
        dropdownMenu.classList.remove('show');
        handleLogout();
      });
      
      // View all coins
      document.getElementById('viewAllCoins').addEventListener('click', showAllCoinsModal);
      
      // Modal close buttons
      document.getElementById('closeCoinModal').addEventListener('click', () => closeModal('coinDetailModal'));
      document.getElementById('closeAllCoinsModal').addEventListener('click', () => closeModal('allCoinsModal'));
      document.getElementById('closeTradeModal').addEventListener('click', () => closeModal('tradeModal'));
      document.getElementById('closePortfolioModal').addEventListener('click', () => closeModal('portfolioModal'));
      document.getElementById('closeLoginModal').addEventListener('click', () => closeModal('loginModal'));
      document.getElementById('closeSignupModal').addEventListener('click', () => closeModal('signupModal'));
      document.getElementById('closeSuccessModal').addEventListener('click', () => closeModal('successModal'));
      document.getElementById('confirmSuccess').addEventListener('click', () => closeModal('successModal'));
      
      // Forms
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      document.getElementById('signupForm').addEventListener('submit', handleSignup);
      
      // Trade buttons (delegated)
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('buy-btn') || e.target.classList.contains('sell-btn')) {
          e.stopPropagation();
          const coinId = e.target.getAttribute('data-coin-id');
          const action = e.target.getAttribute('data-action');
          showTradeForm(coinId, action);
        }
      });
      
      // Stats increment animation
      setInterval(() => {
        // Traders count
        const tradersText = tradersCount.textContent.replace(/,/g, '');
        let traders = parseInt(tradersText) || 8021905;
        traders += Math.floor(Math.random() * 5) + 1;
        tradersCount.textContent = traders.toLocaleString('en-US');
        
        // Volume
        const volumeText = totalVolume.textContent.replace(/[$,]/g, '');
        let volume = parseFloat(volumeText) * 1000000 || 1120000000;
        volume += Math.random() * 1000000;
        totalVolume.textContent = `$${(volume / 1000000).toFixed(2)}B`;
      }, 2000);
    }
    
    // Fallback market data
    function getFallbackMarketData() {
      return [
        {
          id: 'bitcoin',
          name: 'Bitcoin',
          symbol: 'btc',
          image: 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png?1547033579',
          current_price: 66300,
          price_change_percentage_24h: 2.35,
          total_volume: 20154240000,
          market_cap: 950250000000,
          high_24h: 66500,
          low_24h: 65800
        },
        {
          id: 'ethereum',
          name: 'Ethereum',
          symbol: 'eth',
          image: 'https://assets.coingecko.com/coins/images/279/large/ethereum.png?1595348880',
          current_price: 3025.50,
          price_change_percentage_24h: 3.25,
          total_volume: 15254790000,
          market_cap: 350150000000,
          high_24h: 3050,
          low_24h: 3000
        },
        {
          id: 'tether',
          name: 'Tether',
          symbol: 'usdt',
          image: 'https://assets.coingecko.com/coins/images/325/large/Tether.png?1668148663',
          current_price: 1.00,
          price_change_percentage_24h: 0.02,
          total_volume: 45254790000,
          market_cap: 83150000000,
          high_24h: 1.01,
          low_24h: 0.99
        },
        {
          id: 'binancecoin',
          name: 'Binance Coin',
          symbol: 'bnb',
          image: 'https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png?1644979850',
          current_price: 580.25,
          price_change_percentage_24h: 4.55,
          total_volume: 554240000,
          market_cap: 10250000000,
          high_24h: 585,
          low_24h: 575
        },
        {
          id: 'solana',
          name: 'Solana',
          symbol: 'sol',
          image: 'https://assets.coingecko.com/coins/images/4713/large/solana.png?1648133693',
          current_price: 142.75,
          price_change_percentage_24h: 8.25,
          total_volume: 1254790000,
          market_cap: 18150000000,
          high_24h: 145,
          low_24h: 140
        },
        {
          id: 'ripple',
          name: 'XRP',
          symbol: 'xrp',
          image: 'https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png?1605778731',
          current_price: 0.52,
          price_change_percentage_24h: 1.55,
          total_volume: 2154240000,
          market_cap: 25250000000,
          high_24h: 0.53,
          low_24h: 0.51
        },
        {
          id: 'cardano',
          name: 'Cardano',
          symbol: 'ada',
          image: 'https://assets.coingecko.com/coins/images/975/large/cardano.png?1547034860',
          current_price: 0.46,
          price_change_percentage_24h: 2.15,
          total_volume: 854790000,
          market_cap: 15150000000,
          high_24h: 0.47,
          low_24h: 0.45
        },
        {
          id: 'dogecoin',
          name: 'Dogecoin',
          symbol: 'doge',
          image: 'https://assets.coingecko.com/coins/images/5/large/dogecoin.png?1547792256',
          current_price: 0.12,
          price_change_percentage_24h: 12.34,
          total_volume: 654320000,
          market_cap: 12500000000,
          high_24h: 0.125,
          low_24h: 0.115
        },
        {
          id: 'polkadot',
          name: 'Polkadot',
          symbol: 'dot',
          image: 'https://assets.coingecko.com/coins/images/12171/large/polkadot.png?1639712644',
          current_price: 6.75,
          price_change_percentage_24h: 3.45,
          total_volume: 254320000,
          market_cap: 8542000000,
          high_24h: 6.80,
          low_24h: 6.70
        },
        {
          id: 'shiba-inu',
          name: 'Shiba Inu',
          symbol: 'shib',
          image: 'https://assets.coingecko.com/coins/images/11939/large/shiba.png?1622619446',
          current_price: 0.000023,
          price_change_percentage_24h: 8.76,
          total_volume: 354210000,
          market_cap: 12500000000,
          high_24h: 0.000024,
          low_24h: 0.000022
        }
      ];
    }
  </script>
</body>
</html>
